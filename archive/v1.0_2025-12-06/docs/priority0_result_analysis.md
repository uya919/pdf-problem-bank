# Priority 0 패치 적용 결과 분석

**적용일**: 2025-11-16
**패치 내용**: 다단계 모폴로지 연산 (수평/수직 연결)
**테스트 파일**: test.pdf (1페이지)

---

## 1. 정량적 비교

### 1.1 블록 개수 변화

| 항목 | BEFORE | AFTER | 변화 |
|------|--------|-------|------|
| 총 블록 수 | 18개 | 27개 | +50% |
| 예상치 | - | 30-40개 | 목표 하한 근접 |

### 1.2 블록 크기 분석 (상위 5개)

**BEFORE (18개 블록)**:
```
Block 1: [143, 102, 183, 143] - 40×41px  (1,640px²)
Block 2: [386, 129, 408, 163] - 22×34px  (748px²)
Block 3: [246, 129, 303, 164] - 57×35px  (1,995px²)
Block 4: [473, 130, 495, 154] - 22×24px  (528px²)
Block 5: [504, 133, 533, 159] - 29×26px  (754px²)

평균 크기: ~1,000px²
특징: 글자 단위 파편화
```

**AFTER (27개 블록)**:
```
Block 1: [85, 102, 551, 188]   - 466×86px   (40,076px²) ⭐
Block 2: [85, 202, 1189, 1764] - 1104×1562px (1,724,448px²) ⚠️ 매우 큼!
Block 3: [118, 217, 329, 265]  - 211×48px   (10,128px²)
Block 4: [176, 315, 493, 349]  - 317×34px   (10,778px²)
Block 5: [1020, 344, 1062, 366] - 42×22px    (924px²)

평균 크기: ~350,000px² (Block 2 때문에 왜곡)
중앙값: ~10,000px²
특징: 일부는 적절, 일부는 과도하게 병합됨
```

---

## 2. 정성적 분석

### 2.1 긍정적 변화 ✅

**1. 글자 단위 파편화 해결**
- BEFORE: "문", "제", "0", "1" → 4개 블록
- AFTER: "문제 01" 영역이 하나의 큰 블록으로 연결
- ✅ 수평 연결 커널이 효과적으로 작동

**2. 일부 텍스트 라인이 올바르게 검출됨**
- Block 3: [118, 217, 329, 265] - 문제 제목 라인
- Block 4: [176, 315, 493, 349] - 텍스트 라인
- ✅ 의미 있는 단위로 묶임

**3. 블록 개수 증가**
- 18 → 27개 (+50%)
- ✅ 방향성은 맞음 (목표: 50-70개)

### 2.2 부정적 변화 ❌

**1. 과도한 병합 (심각)**
- Block 2: 1104×1562px (1.7M px²)
- 거의 전체 페이지를 덮는 거대 블록 생성
- ❌ 수직 연결이 너무 강력함

**2. 밀집도 이상**
- Block 2의 밀집도: 0.049 (4.9%)
- 정상 텍스트: 0.2~0.4 (20~40%)
- ❌ 배경을 포함한 거대 블록

**3. 여전히 부족한 블록 수**
- 현재: 27개
- 목표: 50-70개
- ❌ 목표의 40-54% 수준

---

## 3. 시각적 비교

### 3.1 BEFORE (18개 블록)
```
특징:
- 각 글자가 개별 박스
- 매우 작고 파편화된 박스들
- 초록색(L)/빨간색(R) 작은 박스들이 산재

문제점:
- 의미 없는 파편
- 사용 불가능한 수준
```

### 3.2 AFTER (27개 블록)
```
특징:
- 상단에 큰 초록색 박스 (Block 1) - 제목 영역
- 중앙에 거대한 빨간색 박스 (Block 2) - 거의 전체 페이지
- 일부 작은 초록색 박스들 (나머지 블록들)

개선점:
- 글자 파편화 해결
- 일부 의미 있는 블록 생성

문제점:
- Block 2가 너무 큼 (과도한 병합)
- 여전히 목표 블록 수에 미달
```

---

## 4. 근본 원인 분석

### 4.1 왜 Block 2가 거대해졌는가?

**적용한 커널**:
```python
# 수평 연결: (30, 1)
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (30, 1))

# 수직 연결: (1, 5)
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 5))
```

**문제**:
1. **수직 커널 (1, 5)**:
   - 5픽셀 범위 내의 수직 요소를 연결
   - 줄 간격: 약 5-10픽셀
   - **결과**: 모든 줄이 연결되어 하나의 거대 블록 형성

2. **MORPH_CLOSE의 연쇄 효과**:
   - 수평 연결 → 각 줄이 긴 막대로
   - 수직 연결 → 긴 막대들이 모두 연결됨
   - **결과**: 거대 블록

### 4.2 이상적인 동작

**기대했던 것**:
```
줄1: [word1] [word2] [word3]
줄2: [word1] [word2]
줄3: [word1] [word2] [word3] [word4]

→ 각 줄이 하나의 블록 (3개 블록)
```

**실제 결과**:
```
[전체가 하나의 거대 블록]
```

---

## 5. 개선 방안

### 5.1 즉시 조치: 커널 크기 조정

**수정 전략**:

**Option A: 수직 커널 축소** (권장)
```python
# 현재
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 5))

# 수정
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 2))  # 5 → 2

# 이유: 수식의 위/아래 첨자만 연결, 일반 줄 간격은 연결 안됨
```

**Option B: 수평 커널 축소**
```python
# 현재
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (30, 1))

# 수정
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (20, 1))  # 30 → 20

# 이유: 단어 내부는 연결, 단어 간은 분리
```

**Option C: 둘 다 조정** (가장 권장)
```python
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (25, 1))  # 30 → 25
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 2))   # 5 → 2
```

### 5.2 추가 필터링

**거대 블록 제거**:
```python
# 블록 크기 상한 설정
MAX_BLOCK_RATIO = 0.5  # 페이지 면적의 50% 이상은 제외

page_area = width * height
for block in blocks:
    if block.area > page_area * MAX_BLOCK_RATIO:
        logger.warning(f"Block {block.id} too large, split or discard")
        # 분할 또는 제외
```

**밀집도 필터링**:
```python
# 너무 희박한 블록 제외
MIN_DENSITY = 0.1  # 10% 미만은 배경 포함 가능성

for block in blocks:
    if block.pixel_density < MIN_DENSITY:
        # 재분석 또는 제외
```

---

## 6. 다음 단계 제안

### 6.1 Priority 0.5: 미세 조정 (15분)

**작업**:
1. 커널 크기 조정 (Option C 적용)
2. 거대 블록 필터링 추가
3. 재테스트

**예상 결과**:
- 블록 수: 27 → 35-45개
- 거대 블록 제거
- 품질: 50% → 65%

### 6.2 Priority 1: 투영 분석 (1-2일)

**이유**:
- 모폴로지만으로는 한계
- 투영 기반 라인 검출 필요
- 참고 이미지 수준 달성

**예상 결과**:
- 블록 수: 35-45 → 50-60개
- 품질: 65% → 80%

---

## 7. 결론

### 7.1 Priority 0 패치 평가

**점수**: ⭐⭐⭐☆☆ (3/5)

**성공한 부분**:
- ✅ 글자 파편화 해결
- ✅ 수평 연결 효과적
- ✅ 방향성 올바름

**실패한 부분**:
- ❌ 수직 연결 과도함
- ❌ 거대 블록 생성
- ❌ 목표 블록 수 미달

**종합 평가**:
```
부분적 성공. 방향은 맞으나 파라미터 튜닝 필요.
수직 커널 크기를 줄이면 큰 개선 기대됨.
```

### 7.2 권장 조치

**즉시 실행** (Priority 0.5):
```python
# src/density_analyzer.py 수정
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (25, 1))  # 30→25
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 2))   # 5→2

# 거대 블록 필터링 추가
if bbox.area > page_area * 0.5:
    continue  # 건너뛰기
```

**다음 단계**:
- Priority 0.5 적용 후 재테스트
- 결과가 만족스러우면 Priority 1 (투영 분석) 진행

---

## 8. 비교 통계 요약

| 지표 | BEFORE | AFTER (P0) | 목표 | 달성률 |
|------|--------|-----------|------|--------|
| 블록 수 | 18 | 27 | 50-70 | 38-54% |
| 평균 블록 크기 | ~1K px² | ~10K px² | ~200 px² | - |
| 글자 파편화 | 심각 | 해결 | 해결 | 100% |
| 라인 단위 인식 | 0% | 20% | 90% | 22% |
| 수식 보존 | 0% | 불명확 | 90% | - |
| 과도한 병합 | 없음 | 심각 (Block 2) | 없음 | 0% |

**종합 품질**:
- BEFORE: 20%
- AFTER: 50% (부분적 개선)
- 목표: 90%
- **다음 패치로 65-70% 달성 예상**

---

**작성자**: Claude Code
**다음 작업**: Priority 0.5 (커널 크기 미세 조정)
