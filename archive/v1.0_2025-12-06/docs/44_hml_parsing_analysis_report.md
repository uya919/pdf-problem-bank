# HML 파싱 실패 원인 분석 리포트

**작성일**: 2025-11-28
**작성자**: Claude Code (Opus)
**대상 파일**: `내신 2024년 인천 미추홀구 인화여고 고1 공통 1학기기말 수학상.Hml`

---

## 1. 요약 (Executive Summary)

### 1.1 문제 현상
- HML 파일 파싱 시 **0개 문제 검출**
- 실제 파일에는 약 20개 이상의 수학 문제가 포함됨

### 1.2 근본 원인
**문제 패턴 불일치**: 현재 파서는 `1.`, `1)`, `[1]` 등의 숫자 기반 패턴을 기대하지만, 해당 파일은 `[출제의도]`를 문제 구분자로 사용함

### 1.3 긴급도
🔴 **높음** - 내신 시험지 형식의 HML 파일이 전혀 파싱되지 않음

---

## 2. 파일 구조 분석

### 2.1 기본 정보
| 항목 | 값 |
|------|-----|
| 파일 크기 | 276,556 bytes |
| XML 루트 태그 | `<HWPML>` |
| HML 버전 | 2.8 |
| 문단(P) 태그 수 | 201개 |
| 비어있지 않은 문단 | 113개 |

### 2.2 XML 태그 분포
```
상위 10개 태그:
- <CHAR>: 341회  ← 텍스트 저장 위치
- <SHAPEOBJECT>: 240회
- <SIZE>: 240회
- <EQUATION>: 227회  ← 수학 수식
- <TEXT>: 223회
- <P>: 201회  ← 문단
- <TAB>: 97회
- <PARALIST>: 43회
- <AUTONUM>: 27회
- <AUTONUM>: 25회
```

### 2.3 텍스트 저장 구조
```xml
<!-- 실제 HML 구조 -->
<P>
  <TEXT>
    <CHAR>출제의도</CHAR>  ← 텍스트가 CHAR 태그의 text 속성에 저장
  </TEXT>
</P>
```

**특이점**: `<T>` 태그가 **0개** (일반적인 HML은 `<T>` 태그에 텍스트 저장)

---

## 3. 근본 원인 분석

### 3.1 문제 #1: 문제 번호 패턴 불일치

#### 현재 파서의 기대 패턴 (problem_extractor.py:23-30)
```python
PROBLEM_PATTERNS = [
    (r'^(\d+)\.\s', 'dot'),           # 1. 2. 3.
    (r'^(\d+)\)\s', 'paren'),         # 1) 2) 3)
    (r'^\[(\d+)\]\s', 'bracket'),     # [1] [2] [3]
    (r'^(\d+)번\s', 'number'),        # 1번 2번
    (r'^문제\s*(\d+)', 'question'),   # 문제 1
]
```

#### 실제 파일의 문제 구조
```
[출제의도] 점 A(-1, 2), B(7, -6)을 지나는 직선과 평행하고...
① rm 1② rm 2③ rm 3
④ rm 4⑤ rm 5
[정답] ②
[4.20점]
```

**핵심**: 문제가 `[출제의도]`로 시작하며, 숫자 기반 패턴이 **전혀 없음**

### 3.2 추출된 문단 내용 샘플
```
[ 0] '출제의도란입니다.출제의도란입니다...'
[ 5] '내신 2024년 인천 미추홀구 인화여고 고1공통 1학기기말 수학상'
[ 6] '1'
[10] '[출제의도] 점'
[13] '[출제의도] 점 A(-1, 2), B(7, -6)을 지나여 직선...'
[15] '[4.20점]'
[16] '① 4x-y=0② 4x-y-7=0'
```

### 3.3 패턴 매칭 결과
| 패턴 | 설명 | 매칭 수 |
|------|------|---------|
| `^(\d+)\.\s` | N. | 0개 |
| `^(\d+)\)\s` | N) | 0개 |
| `^\[(\d+)\]\s` | [N] | 0개 |
| `^(\d+)번\s` | N번 | 0개 |
| `^문제\s*(\d+)` | 문제 N | 0개 |
| **모든 패턴** | - | **0개** |

---

## 4. 문서 형식 특징 (내신 시험지 스타일)

### 4.1 인화여고 내신 시험지 구조
```
[출제의도] 문제 설명...
수식/그림
① 보기1 ② 보기2 ③ 보기3
④ 보기4 ⑤ 보기5
[정답] ②
[4.20점]
```

### 4.2 핵심 차별점
| 항목 | 일반 문제집 | 내신 시험지 (인화여고) |
|------|------------|----------------------|
| 문제 시작 | `1.`, `1)`, `문제1` | `[출제의도]` |
| 보기 형식 | 줄바꿈 분리 | 원문자 연속 (①②③④⑤) |
| 배점 | 별도 표시 없음 | `[4.20점]` 형태 |
| 정답 | 별도 정답지 | `[정답] ②` 인라인 |

---

## 5. 추가 발견 사항

### 5.1 수식 데이터
- EQUATION 태그: **227개**
- 수식 형식: HWP 전용 수식 문법 (LaTeX 유사)
```
'LEFT |  `x-5 ` RIGHT | <3`'
'rm A it LEFT (-1,`` 2 RIGHT )'
'2 x+1  leq 5  leq x+a`'
```

### 5.2 정답 데이터 존재 확인
- 원문자(①②③④⑤): **102개** 발견
- `[정답]` 태그: 다수 존재
- `[X.XX점]` 배점: 다수 존재

**결론**: 문제/정답 데이터는 파일에 존재하나, **패턴 불일치로 추출 실패**

---

## 6. 개선 방안

### 6.1 즉시 적용 가능 (Phase 19)

#### 방안 A: 문제 패턴 확장
```python
PROBLEM_PATTERNS = [
    # 기존 패턴들...
    (r'^\[출제의도\]', 'purpose'),     # [출제의도] 형식 추가
    (r'^【(\d+)】', 'korean_bracket'), # 【1】 형식
]
```

#### 방안 B: 배점 기반 문제 분리
```python
# 새로운 접근: [X.XX점] 패턴으로 문제 종료 지점 감지
POINTS_PATTERN = r'\[(\d+\.?\d*)점\]'
# 배점 → 이전 내용이 한 문제
```

### 6.2 중기 개선 (권장)

#### 템플릿 기반 파싱 시스템
```python
class ExamTemplateDetector:
    """시험지 템플릿 자동 감지"""

    TEMPLATES = {
        'standard': {  # 일반 문제집
            'problem_start': r'^(\d+)\.\s',
            'answer_section': True,
        },
        'inhwa_exam': {  # 인화여고 스타일
            'problem_start': r'^\[출제의도\]',
            'inline_answer': r'\[정답\]\s*([①②③④⑤])',
            'points': r'\[(\d+\.?\d*)점\]',
        }
    }

    def detect_template(self, text: str) -> str:
        """문서 특성으로 템플릿 자동 감지"""
        if '[출제의도]' in text:
            return 'inhwa_exam'
        return 'standard'
```

### 6.3 장기 로드맵

1. **ML 기반 문제 경계 감지**: 패턴에 의존하지 않는 지능형 분리
2. **사용자 정의 템플릿**: 학교/출판사별 형식 등록 기능
3. **OCR 통합**: 스캔 문서 지원

---

## 7. 기술적 상세

### 7.1 현재 파싱 플로우
```
HML 파일
    ↓
hml_parser.py: extract_text()
    ↓ (P/TEXT/CHAR 태그에서 텍스트 추출)
paragraphs: List[str] (113개)
    ↓
problem_extractor.py: extract_problems()
    ↓ (_match_problem_start로 패턴 매칭)
problems: List[ParsedProblem] (0개 ← 문제!)
```

### 7.2 실패 지점
```python
# problem_extractor.py:274-290
def _match_problem_start(self, text: str) -> Optional[PatternMatch]:
    for pattern, pattern_type in self.PROBLEM_PATTERNS:
        match = re.match(pattern, text.strip())  # ← 여기서 모두 실패
        if match:
            return PatternMatch(...)
    return None  # ← 항상 None 반환
```

### 7.3 텍스트 추출은 정상
```python
# hml_parser.py의 텍스트 추출은 정상 작동
# itertext() 사용 시 113개 문단 추출 성공
for p_elem in root.iter('P'):
    full_text = ''.join(p_elem.itertext())  # ✅ 텍스트 추출 성공
```

---

## 8. 권장 조치

### 8.1 긴급 (Phase 19-1)
- [ ] `[출제의도]` 패턴을 PROBLEM_PATTERNS에 추가
- [ ] 배점 패턴 `[X.XX점]` 활용한 문제 분리 로직 추가

### 8.2 검증 필요
- [ ] 다른 내신 시험지 샘플로 패턴 검증
- [ ] 기존 문제집 파싱에 영향 없는지 회귀 테스트

### 8.3 문서화
- [ ] 지원 문서 형식 목록 정리
- [ ] 사용자 가이드에 지원 형식 명시

---

## 9. 결론

**문제 미검출의 원인은 단순합니다:**

> 파서가 `1.`, `1)` 같은 숫자 패턴을 기대하지만,
> 해당 파일은 `[출제의도]`로 문제를 구분하는 **다른 형식**을 사용합니다.

텍스트 추출 자체는 정상 동작하며, **패턴 확장만으로 해결 가능**합니다.

---

## 부록: 분석 스크립트

분석에 사용된 스크립트:
- `c:\MYCLAUDE_PROJECT\pdf\analyze_hml.py`
- `c:\MYCLAUDE_PROJECT\pdf\analyze_hml2.py`

---

*작성: Claude Code (Opus)*
*날짜: 2025-11-28*
