# 블록 검출 최적화 및 멈춤 현상 해결 계획

## 1. 문제 상황 분석

### 1.1 현상
- **증상**: 웹 애플리케이션(Antigravity)에서 PDF 페이지를 열 때 심각한 멈춤(Freezing) 현상 발생.
- **원인**: 한 페이지당 **수천~수만 개의 블록**이 생성되어 프론트엔드 렌더링 부하 발생.
- **기술적 배경**:
  - 현재 `src/config.py`의 `MIN_BLOCK_SIZE`가 **2px**로 설정됨.
  - PDF 스캔 노이즈, 미세한 점, 먼지 등이 모두 개별 블록으로 인식됨.
  - React-Konva가 수천 개의 Rect 컴포넌트를 렌더링하면서 브라우저 메인 스레드 차단.

### 1.2 기존 로직의 한계
현재 `src/density_analyzer.py`의 필터링 로직:
```python
if w < self.min_block_size or h < self.min_block_size:
    continue
```
- **문제점**: 가로 또는 세로 중 **하나만** 작아도 제거됨.
- **딜레마**:
  - `MIN_BLOCK_SIZE`를 키우면(예: 10px) → 노이즈는 사라지지만, **빼기(-), 등호(=), 분수선** 같은 얇은 기호도 함께 사라짐.
  - `MIN_BLOCK_SIZE`를 줄이면(예: 2px) → 기호는 살지만, **노이즈가 폭증**하여 앱이 멈춤.

---

## 2. 해결 방안 (Proposed Solution)

### 2.1 필터링 로직 개선 (핵심)
단순 크기 비교 조건을 `OR`에서 **`AND`**로 변경하여, **"가로와 세로가 모두 작은 경우"**에만 노이즈로 간주하고 제거합니다.

**변경 전 (OR 조건):**
> "가로가 작거나, 세로가 작으면 지운다."
> -> 빼기 기호(가로 20, 세로 3)는 세로가 작아서 지워짐 (X)

**변경 후 (AND 조건):**
> "가로도 작고, 세로도 작으면 지운다."
> -> 빼기 기호(가로 20, 세로 3)는 가로가 크므로 살아남음 (O)
> -> 점/먼지(가로 3, 세로 3)는 둘 다 작으므로 지워짐 (O)

### 2.2 설정값 조정
로직 변경 후, `MIN_BLOCK_SIZE`를 안전하게 상향 조정합니다.
- **기존**: 2px
- **변경**: **10px ~ 15px** (권장)

### 2.3 기대 효과
- **성능**: 불필요한 노이즈 블록 90% 이상 제거 → 렌더링 속도 획기적 개선.
- **정확도**: 수학 기호(빼기, 분수선 등) 보존율 유지.

---

## 3. 구현 계획 (Implementation Plan)

### 3.1 `src/config.py` 수정
- `MIN_BLOCK_SIZE` 기본값을 `2`에서 **`12`**로 변경.
- 주석에 변경 사유 명시.

### 3.2 `src/density_analyzer.py` 수정
`_find_blocks` 메서드 내의 필터링 조건 수정.

```python
# [수정 전]
if w < self.min_block_size or h < self.min_block_size:
    continue

# [수정 후]
# 가로/세로 둘 다 설정값보다 작을 때만 제거 (점/노이즈 제거)
if w < self.min_block_size and h < self.min_block_size:
    continue

# 추가 안전장치: 한쪽이 너무 얇은 경우(1px 이하)는 노이즈일 확률이 높으므로 제거 (선택 사항)
if w <= 1 or h <= 1:
    continue
```

### 3.3 검증 (Verification)
1. **단위 테스트**: `빼기(-)` 기호와 `점(.)` 노이즈가 있는 샘플 이미지로 로직 검증.
2. **통합 테스트**: 실제 PDF를 처리하여 생성되는 블록 개수 비교 (수천 개 → 수백 개 예상).
3. **UI 테스트**: 웹앱에서 페이지 로딩 속도 및 멈춤 현상 해소 확인.

---

## 4. 일정 및 담당
- **담당**: Claude Code (Antigravity)
- **일정**: 즉시 적용 가능
- **비고**: 적용 후 기존에 분석된 데이터(`blocks/*.json`)는 재생성해야 효과가 반영됨.
