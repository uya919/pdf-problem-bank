# Phase 19-D: 문제 경계 추출 개선 - 완료 리포트

**작성일**: 2025-11-29
**상태**: 완료

---

## 1. 개요

### 1.1 목표
- HML 파일에서 문제 본문 추출 시 헤더/푸터 정보가 포함되는 문제 해결
- 기대 결과: `"1. 부등식 |x-5|<3의 해가..."` (헤더/푸터 없이 깨끗한 본문)

### 1.2 결과
- **21/21 문제 정상 추출 (100%)**
- 모든 문제에서 헤더/푸터/메타 정보 제거 완료

---

## 2. 수정된 파일

### 2.1 `backend/app/services/hangul/hml_parser.py`

#### 수정 1: ENDNOTE P 태그 제외 (lines 585-596)
```python
# Phase 19-D: ENDNOTE 내 P 태그 제외 (본문 P 태그만 사용)
autonum_positions = []

# ENDNOTE 내 P 태그들을 먼저 수집 (제외 대상)
endnote_p_elements = set()
for endnote in self.root.iter('ENDNOTE'):
    for p in endnote.iter('P'):
        endnote_p_elements.add(p)

# ENDNOTE P 태그를 제외한 본문 P 태그만 수집
all_p_elements = [p for p in self.root.iter('P') if p not in endnote_p_elements]
```

**효과**: 문제 2, 9, 10번이 선택지 대신 실제 문제 본문을 표시

#### 수정 2: `_clean_problem_content()` 개선 (lines 656-715)

주요 정제 패턴:
1. `[정답]` 태그 제거 (한국어 매칭 방지)
2. HWP 개체 대체 텍스트 제거 (`선입니다`, `사각형입니다` 등)
3. `수학영역` 완전 제거
4. 교시 정보 제거
5. 앞쪽 선택지 패턴 제거
6. **문제 키워드 기반 본문 시작점 감지**
7. **푸터 제거 (중간점 이후 확인)**

---

## 3. 해결된 문제

| 문제 | 증상 | 원인 | 해결 |
|------|------|------|------|
| 문제 1 헤더 | "내신 2024년 인화여고..." 포함 | 정제 패턴 부족 | 문제 키워드 기반 시작점 감지 |
| 문제 2,9,10 | 선택지만 표시 | ENDNOTE P 태그 포함 | ENDNOTE P 제외 로직 |
| 문제 5 | 선택지로 시작 | 앞쪽 선택지 미제거 | 선택지 패턴 제거 추가 |
| 문제 21 푸터 | "내신 2024년..." 끝에 포함 | 푸터 제거 범위 문제 | 중간점 이후 검색 |

---

## 4. 핵심 발견

### 4.1 HML 파일 구조
- **SECTION**: 201개 P 태그 (본문 + 메타)
- **ENDNOTE**: 21개 P 태그 (정답만)
- AUTONUM이 본문과 ENDNOTE에서 각각 나타남

### 4.2 Python regex 주의점
- `\w`가 한국어 문자도 매칭함
- `[정답]\w*` 패턴이 "부등식..." 등을 삭제하는 문제 발생
- 해결: 명시적으로 `[①②③④⑤]?`만 매칭

### 4.3 문제 본문 시작점 키워드
```python
problem_keywords = (
    r'(부등식|방정식|이차방정식|연립부등식|연립방정식|'
    r'함수|다항식|이차함수|삼차함수|'
    r'점\s*[A-Z]|직선|원\s|삼각형|사각형|평면|좌표평면|좌표|'
    r'두\s*수|세\s*수|실수|정수|자연수|유리수|'
    r'그림|한\s*개|다음|아래)'
)
```

---

## 5. 테스트 결과

### 5.1 문제별 추출 결과 (처음 50자)
```
 1. 부등식 | x-5 | <3의 해가 a<x<8일 때, 실수 a의 값은?...
 2. 점 A (-1, 2 ), B (7, -6 )에 대하여 선분 AB의 중점을 지나고...
 3. 점 A (4, a ), B ( 1 , 4 ), C (b , 2 )를 꼭짓점으로...
 4. 연립부등식 2 x+1 ≤ 5 ≤ x+a의 해가 -1 ≤ x ≤ b일 때...
 5. 한 개에 500원인 과자와 한 개에 200원인 사탕을 합하여...
 ...
21. 그림과 같이 세 점 O (0, 0 ), A (3, 6 ), B (6, 2 )를...
```

### 5.2 검증 항목
- [x] 헤더 정보 미포함 ("내신 2024년", "인화여고")
- [x] "수학영역" 미포함
- [x] 선택지로 시작하지 않음
- [x] 푸터 정보 미포함

---

## 6. 관련 문서

- [26_phase19d_problem_boundary_research_report.md](26_phase19d_problem_boundary_research_report.md) - 사전 연구 리포트
- [25_phase19c_latex_rendering_issue_report.md](25_phase19c_latex_rendering_issue_report.md) - LaTeX 변환 이슈

---

## 7. 향후 개선 가능 사항

1. **선택지 별도 추출**: 현재 본문에 포함, 별도 필드로 분리 가능
2. **문제 번호 P 태그 기반 경계**: 더 정확한 문제 영역 설정
3. **다양한 HML 파일 테스트**: 다른 형식의 내신 문제지 검증

---

*Phase 19-D 완료 - 2025-11-29*
