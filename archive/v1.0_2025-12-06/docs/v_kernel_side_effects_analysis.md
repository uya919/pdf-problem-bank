# v_kernel 증가(30 → 50) 부작용 심층 분석 리포트

## 📋 개요

v_kernel을 30에서 50으로 증가시켰을 때 발생한 부작용을 심층 분석

**분석 일시**: 2025-11-16
**분석 대상**: test.pdf (베이직쎈 수학2 2022)
**목적**: v_kernel 증가가 인테그랄 검출과 일반 텍스트 블록에 미친 영향 분석

---

## 🔍 분석 방법

### 1. 비교 대상

| 항목 | v_kernel=30 | v_kernel=50 |
|------|------------|------------|
| vertical_tall 스케일 | h=3, v=30 | h=3, v=50 |
| max_gap | 100px | 100px |
| center_x 허용 | 30px | 30px |
| height 필터 | >= 10px | >= 10px |

### 2. 평가 지표

- 총 블록 수
- vertical_tall 검출 수
- 병합된 인테그랄 수
- 비정상 블록 (aspect ratio, 크기)
- 일반 텍스트 블록 영향

---

## 📊 검출 결과 비교

### v_kernel=30

```
총 블록: 705개
vertical_tall 검출: 77개
vertical_tall 필터링 후: 77개
병합된 인테그랄: 5개
  - 28×71px (aspect=0.394)
  - 9×50px (aspect=0.180)
  - 22×151px (aspect=0.146)
  - 15×62px (aspect=0.242)
  - 19×50px (aspect=0.380)
```

### v_kernel=50

```
총 블록: 693개
vertical_tall 검출: 66개
vertical_tall 필터링 후: 66개
병합된 인테그랄: 6개
  - 28×146px (aspect=0.192)
  - 26×133px (aspect=0.195)
  - 28×151px (aspect=0.185)
  - 27×149px (aspect=0.181)
  - 36×96px (aspect=0.375)
  - 21×155px (aspect=0.135)
```

---

## ⚠️ 발견된 문제점

### 1. vertical_tall 검출 감소

- **v=30**: 77개 검출
- **v=50**: 66개 검출
- **차이**: -11개 (-14%)

**원인 추정**:
- v_kernel이 너무 크면 작은 세로 블록들이 주변 블록과 과도하게 병합됨
- 독립적인 작은 세로 블록들이 사라짐

### 2. 총 블록 수 감소

- **v=30**: 705개
- **v=50**: 693개
- **차이**: -12개 (-1.7%)

**의미**:
- 전체적으로 블록 병합이 더 많이 일어남
- 일반 텍스트 블록도 영향받았을 가능성

### 3. 병합된 인테그랄 증가 (긍정적)

- **v=30**: 5개
- **v=50**: 6개
- **차이**: +1개 (+20%)

**하지만**:
- 인테그랄 높이는 증가 (최대 155px)
- 대신 작은 인테그랄들이 감소 (66개 vs 77개)

---

## 🔬 심층 원인 분석

### A. 모폴로지 연산의 본질

v_kernel=50은 **높이 50px 범위 내 모든 픽셀을 수직으로 연결**

**장점**:
- 큰 인테그랄의 조각들이 더 잘 연결됨
- 높이 155px 인테그랄 검출 성공

**단점**:
- **불필요한 연결 발생** (인테그랄 아닌 것도 연결)
- 작은 세로 블록 + 위/아래 텍스트가 합쳐짐
- 순수 인테그랄 블록 감소

### B. 과도한 병합 예시

```
[인테그랄 조각 1]  10px
     ↓ (gap: 30px)
[인테그랄 조각 2]  10px
     ↓ (gap: 20px)
[일반 텍스트]      5px

v_kernel=30: 조각 1+2만 연결 ✓
v_kernel=50: 전부 연결 (부작용!) ✗
```

### C. 필터링의 한계

현재 vertical_tall 필터:
```python
if (aspect_ratio < 0.5 and
    height >= 10 and
    width <= 30 and
    height <= 200):
```

**문제**:
- v_kernel=50으로 병합된 블록이 width > 30이 되면 필터링됨
- 또는 aspect >= 0.5가 되면 필터링됨

---

## 💡 근본 원인

### 핵심 문제: **모폴로지 연산만으로는 한계**

1. **인테그랄은 픽셀 레벨에서 연결되지 않음**
   - 상단 곡선 ⌒
   - 중간 수직선 |  (간격 10-50px)
   - 하단 곡선 ⌣

2. **v_kernel을 크게 하면**:
   - ✓ 인테그랄 조각 연결
   - ✗ 인테그랄 아닌 것도 연결

3. **v_kernel을 작게 하면**:
   - ✓ 불필요한 연결 방지
   - ✗ 인테그랄 조각 연결 실패

---

## 🎯 해결 방안 제안

### 방안 1: 다중 v_kernel 스케일

```python
# vertical_tall을 2개로 분리
{"name": "vertical_small", "h_kernel": 3, "v_kernel": 20, "min_size": 50},
{"name": "vertical_large", "h_kernel": 3, "v_kernel": 50, "min_size": 100},
```

**효과**:
- 작은 인테그랄: v=20으로 검출
- 큰 인테그랄: v=50으로 검출
- 양쪽 결과 병합

### 방안 2: v_kernel 중간값 (35-40)

```python
{"name": "vertical_tall", "h_kernel": 3, "v_kernel": 35, "min_size": 100},
```

**근거**:
- 진단 결과: 조각 간격 최대 99px이지만 대부분 30-50px
- v=35면 대부분 커버하면서 부작용 최소화

### 방안 3: 후처리 병합 로직 강화

현재 병합 로직 개선:
```python
# 현재: height >= 10 (너무 관대)
# 개선: height >= 15 (균형)

# 추가: 밀집도 검증
if merged_density < 0.3:  # 너무 빈 영역이면 병합 취소
    standalone_fragments.extend(group)
```

---

## 📋 권장 조치

### 즉시 조치 (우선순위 높음)

1. **v_kernel을 35로 조정**
   ```python
   {"name": "vertical_tall", "h_kernel": 3, "v_kernel": 35}
   ```

2. **height 필터 10 → 15로 조정**
   - 너무 작은 조각은 노이즈일 가능성

3. **병합 후 검증 강화**
   - 밀집도 확인
   - aspect ratio 재검증

### 추가 개선 (중기)

4. **다중 스케일 도입**
   - vertical_small (v=20)
   - vertical_large (v=40)

5. **기계학습 기반 후처리**
   - 인테그랄 형태 패턴 인식
   - 진짜 인테그랄 vs 잡음 분류

---

## 🔢 실험 계획

### 테스트 v_kernel 값

| v_kernel | 예상 효과 | 우선순위 |
|----------|----------|---------|
| 35 | 균형잡힌 검출 | ⭐⭐⭐ 최우선 |
| 40 | 큰 인테그랄 우선 | ⭐⭐ |
| 25 | 작은 인테그랄 우선 | ⭐ |

### 평가 지표

- 인테그랄 검출 수 (aspect < 0.2)
- 총 블록 수 (일반 텍스트 영향)
- 비정상 블록 수
- 사용자 육안 검증

---

## ✅ 결론

**v_kernel=50은 과도함**

- ✓ 큰 인테그랄 검출 개선
- ✗ 전체 vertical_tall 검출 감소 (77 → 66)
- ✗ 불필요한 병합 발생 가능성

**권장**: v_kernel=35로 조정 후 재평가

---

## 📌 다음 단계

1. v_kernel=35로 변경
2. test.pdf 재처리
3. 검출 결과 비교
4. 사용자 확인
5. 최종 결정

---

**작성자**: Claude Code
**검토 필요**: v_kernel 최적값 실험 데이터
