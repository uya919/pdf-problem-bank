# Phase 53 버그 리포트: 크로스 컬럼 Export 이슈

**작성일**: 2025-12-05
**심각도**: 높음
**상태**: 분석 완료

---

## 현상

### 사용자 기대
```
┌─────────────┐
│   L 영역    │  ← L 블록만 크롭 (왼쪽 컬럼)
│   (위쪽)    │
├─────────────┤
│   R 영역    │  ← R 블록만 크롭 (오른쪽 컬럼)
│   (아래쪽)  │
└─────────────┘
```

### 실제 결과
```
┌─────────────────────────────────┐
│                                 │
│   L 영역      빈 공간      R 영역 │  ← 전체 영역을 하나의 큰 사각형으로 크롭
│                                 │
└─────────────────────────────────┘
```

---

## 데이터 확인

### 저장된 그룹 데이터 (정상)
```json
{
  "id": "p7_X1",
  "column": "X",
  "block_ids": [...196개...],
  "segments": [
    {
      "column": "L",
      "block_ids": [...52개...],
      "order": 0
    },
    {
      "column": "R",
      "block_ids": [...144개...],
      "order": 1
    }
  ]
}
```

### 블록 데이터 (정상)
- Block 1628: `column: "L"`, `bbox: [152, 1604, 184, 1625]`
- Block 16: `column: "R"`, `bbox: [898, 141, 903, 149]`
- L 블록들과 R 블록들이 올바르게 분리되어 있음

---

## 원인 분석

### 가설 1: Frontend 미리보기 로직 문제
- **가능성**: 높음
- **설명**: Frontend에서 그룹 미리보기를 표시할 때 Backend export 엔드포인트를 사용하지 않고, 전체 bbox로 Canvas에서 직접 표시
- **증거**: 미리보기가 즉시 표시되며 Backend 호출 없이 동작

### 가설 2: Export 엔드포인트 미호출
- **가능성**: 중간
- **설명**: 사용자가 "저장" 버튼을 눌렀을 때 실제 export 함수가 호출되지 않음
- **증거**: problems 폴더에 p7_X1 관련 파일 없음

### 가설 3: Export 로직 오류
- **가능성**: 낮음
- **설명**: export.py의 크로스 컬럼 처리 로직에 버그
- **증거**: 코드 리뷰 결과 로직은 올바르게 구현됨

---

## 핵심 문제

### 미리보기 vs Export 불일치

현재 시스템:
```
┌─────────────────────────────────────────────────────────┐
│ Frontend                                                 │
│                                                         │
│  PageCanvas.tsx                                         │
│  - 그룹 블록들의 전체 bbox 계산                          │
│  - 해당 영역을 직사각형으로 표시                          │
│  - 세그먼트별 분리 표시 없음 ← 문제점                     │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ Backend                                                  │
│                                                         │
│  export.py                                               │
│  - segments가 있으면 각각 크롭 후 합성                   │
│  - 올바르게 구현됨                                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 해결 방안

### 방안 1: Frontend 미리보기 개선 (권장)

**작업 내용**:
1. PageCanvas에서 X 그룹 표시 시 segments별로 분리된 영역 표시
2. GroupPanel 미리보기에서 실제 export 결과와 동일한 이미지 표시

**장점**:
- 사용자가 export 전에 결과 미리 확인 가능
- WYSIWYG 원칙 준수

**단점**:
- Frontend 복잡도 증가
- 추가 개발 필요

### 방안 2: Export 확인 후 미리보기

**작업 내용**:
1. 그룹 생성 시 바로 Backend에서 합성 이미지 생성
2. 합성된 이미지를 Base64로 Frontend에 전달하여 표시

**장점**:
- Frontend/Backend 일관성 보장
- 정확한 미리보기

**단점**:
- API 호출 증가
- 실시간성 저하

### 방안 3: Canvas 연산으로 클라이언트 합성

**작업 내용**:
1. Frontend에서 HTML Canvas를 사용하여 세그먼트별 영역 크롭
2. 클라이언트에서 세로 합성

**장점**:
- Backend 호출 없이 즉시 미리보기
- 빠른 응답

**단점**:
- Canvas 조작 복잡도
- 메모리 사용량 증가

---

## 권장 해결책

### 2단계 접근법

#### Phase 1: 분리 영역 시각화 (단기)
```
현재:
┌─────────────────────────────────┐
│█████████████████████████████████│  ← 하나의 큰 직사각형 (주황색)
└─────────────────────────────────┘

개선:
┌─────────────┐     ┌─────────────┐
│█████████████│     │█████████████│  ← 두 개의 분리된 직사각형
│  L (주황)   │     │  R (주황)   │    점선으로 연결
└─────────────┘ ··· └─────────────┘
```

- PageCanvas에서 X 그룹의 segments를 각각 별도 Rect로 렌더링
- 두 영역을 점선으로 연결하여 하나의 그룹임을 표시

#### Phase 2: Export 실행 후 확인 (중기)
- Export 버튼 클릭 시 Backend에서 합성
- 합성된 이미지를 모달로 표시하여 확인

---

## 구현 가능성

| 항목 | 난이도 | 시간 | 위험도 |
|------|--------|------|--------|
| Phase 1: 분리 시각화 | 중간 | 1-2시간 | 낮음 |
| Phase 2: Export 확인 | 쉬움 | 30분 | 낮음 |
| 전체 | - | 2-3시간 | 낮음 |

---

## 우려 사항

### 1. 성능
- segments가 많을 경우 렌더링 부하
- 대응: 10개 이상 segments는 단순화 표시

### 2. 기존 호환성
- 기존 L/R 그룹 로직에 영향 없음
- X 그룹에만 새 로직 적용

### 3. UX 혼란
- 분리된 영역이 하나의 그룹임을 명확히 표시 필요
- 대응: 점선 연결, 동일 색상, "좌우 합성" 라벨

---

## 결론

**현재 상태**:
- Backend export 로직은 올바르게 구현됨
- Frontend 미리보기가 segments를 고려하지 않고 전체 bbox로 표시

**해결책**:
1. PageCanvas에서 X 그룹의 segments를 분리 표시
2. Export 실행 후 합성 결과 확인 기능 추가

**"진행해줘"로 구현을 시작합니다.**

---

*Phase 53 크로스 컬럼 기능의 시각화 개선*
