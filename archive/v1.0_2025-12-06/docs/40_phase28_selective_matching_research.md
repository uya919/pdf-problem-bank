# Phase 28: 선택적 매칭 워크플로우 연구 리포트

## 요청 사항

듀얼 매칭창에서:
1. **문제 클릭 → 해설 그룹핑 → 자동 연결**: 해설이 연결 안된 문제를 클릭하고, 해설창에서 그룹핑하면 자동으로 연결
2. **매칭 없으면 그룹핑 불가**: 해설창에서 문제가 선택되지 않으면 그룹핑 자체가 안됨

---

## 현재 시스템 분석

### 현재 워크플로우 (FIFO 자동 매칭)

```
문제창                              해설창
┌──────────────────┐            ┌──────────────────┐
│ 블록 드래그      │            │ 블록 드래그      │
│      ↓           │            │      ↓           │
│ G키로 그룹 생성  │            │ G키로 그룹 생성  │
│      ↓           │            │      ↓           │
│ 대기 목록에 추가 │──────────→│ 가장 오래된      │
│ (FIFO 순서)      │            │ 문제와 자동 매칭 │
└──────────────────┘            └──────────────────┘
```

**현재 구조의 특징:**
- 문제 생성 순서대로 자동 매칭 (FIFO)
- 사용자가 어떤 문제와 매칭할지 선택 불가
- 해설창에서 그룹핑하면 무조건 첫 번째 대기 문제와 연결

### 현재 코드 위치

| 기능 | 파일 | 함수 |
|------|------|------|
| 그룹 생성 | `PageViewer.tsx` | `handleCreateGroup()` |
| 자동 매칭 | `useAutoMatching.ts` | `onSolutionLabeled()` |
| 창간 통신 | `useSyncChannel.ts` | `send()`, `onMessage()` |
| 매칭 저장 | `matching.py` | `POST /api/matching/matches` |

---

## 제안하는 워크플로우

### 새로운 "선택적 매칭" 방식

```
문제창                              해설창
┌──────────────────┐            ┌──────────────────┐
│ 1. 해설 없는     │            │ 3. 블록 드래그   │
│    문제 클릭     │            │    (선택된 문제  │
│      ↓           │─────────→ │     있을 때만    │
│ 2. 선택 상태     │  메시지    │     활성화)      │
│    해설창에 전달 │            │      ↓           │
│                  │            │ 4. G키로 그룹    │
│                  │            │    생성 + 매칭   │
│                  │←───────────│      ↓           │
│ 5. 매칭 완료     │   메시지   │ 선택된 문제와    │
│    표시 업데이트 │            │ 연결!            │
└──────────────────┘            └──────────────────┘
```

### UI/UX 디자인

#### 1. 문제창 - 문제 선택 UI

```
┌─────────────────────────────────┐
│  📘 문제 1 [해설 없음]          │  ← 클릭 가능
│  ┌─────────────────────────┐   │
│  │  [클릭하여 해설 연결]    │   │  ← 호버 시 표시
│  └─────────────────────────┘   │
├─────────────────────────────────┤
│  📘 문제 2 ✅ 해설 연결됨       │  ← 클릭 불가 (흐리게)
├─────────────────────────────────┤
│  📘 문제 3 [해설 없음]          │  ← 선택됨 상태
│  ┌─────────────────────────┐   │
│  │  🔵 선택됨 - 해설창에서  │   │  ← 선택 표시
│  │     그룹핑하세요        │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘
```

#### 2. 해설창 - 조건부 그룹핑

```
┌────────────────────────────────────────┐
│  📗 해설창                             │
│  ┌──────────────────────────────────┐ │
│  │  🔵 "문제 3"과 연결 대기중        │ │  ← 상단 알림
│  │  블록을 선택하고 G키를 누르세요   │ │
│  └──────────────────────────────────┘ │
│                                        │
│  [블록 선택 영역...]                   │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │ 선택된 블록: 3개                  │ │
│  │ [G] 그룹 생성 (문제 3과 연결)     │ │  ← 활성화
│  └──────────────────────────────────┘ │
└────────────────────────────────────────┘
```

#### 3. 문제 선택 안됐을 때 (그룹핑 비활성화)

```
┌────────────────────────────────────────┐
│  📗 해설창                             │
│  ┌──────────────────────────────────┐ │
│  │  ⚠️ 문제를 먼저 선택하세요        │ │  ← 경고
│  │  문제창에서 해설 없는 문제 클릭   │ │
│  └──────────────────────────────────┘ │
│                                        │
│  [블록 선택 영역...]                   │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │ 선택된 블록: 3개                  │ │
│  │ [G] 그룹 생성 (비활성화)          │ │  ← 비활성화됨
│  │     └→ 문제를 먼저 선택해주세요   │ │
│  └──────────────────────────────────┘ │
└────────────────────────────────────────┘
```

---

## 구현 가능성 분석

### ✅ 가능한 부분 (기존 인프라 활용)

| 기능 | 현재 상태 | 활용 방법 |
|------|---------|----------|
| 창간 통신 | ✅ BroadcastChannel | 문제 선택 메시지 추가 |
| 문제 목록 | ✅ 페어에서 조회 | 해설 없는 문제 필터링 |
| 그룹 연결 | ✅ GroupLink 모델 | 그대로 사용 |
| 매칭 저장 | ✅ API 존재 | 그대로 사용 |

### ⚠️ 새로 구현 필요

| 기능 | 설명 | 복잡도 |
|------|------|--------|
| 문제 선택 상태 | 문제창에서 선택한 문제 상태 관리 | 🟢 낮음 |
| 선택 UI | 문제 카드 클릭 → 선택 표시 | 🟢 낮음 |
| 선택 메시지 | `PROBLEM_SELECTED` 메시지 타입 | 🟢 낮음 |
| 해설창 상태 | 선택된 문제 표시 + 그룹핑 조건 | 🟡 중간 |
| 그룹핑 조건 | 선택 없으면 그룹핑 차단 | 🟡 중간 |

---

## 상세 구현 계획

### Phase 28-A: 문제 선택 상태 관리 (2시간)

```typescript
// 새 메시지 타입 추가 (matching.ts)
interface ProblemSelectedPayload {
  problemNumber: string;
  groupId: string;
  documentId: string;
  pageIndex: number;
  selectedAt: number;
}

type SyncMessage =
  | { type: 'PROBLEM_LABELED'; ... }
  | { type: 'PROBLEM_SELECTED'; payload: ProblemSelectedPayload }  // 추가
  | { type: 'PROBLEM_DESELECTED'; payload: { groupId: string } }   // 추가
  | ...;
```

### Phase 28-B: 문제창 UI 개선 (3시간)

1. **그룹 카드에 선택 기능 추가**
   - 해설 없는 문제만 클릭 가능
   - 클릭 시 시각적 선택 표시
   - BroadcastChannel로 `PROBLEM_SELECTED` 전송

2. **선택 상태 시각화**
   - 선택된 문제: 파란 테두리 + "선택됨" 뱃지
   - 해설 있는 문제: 초록 체크 + 클릭 비활성화

### Phase 28-C: 해설창 조건부 그룹핑 (4시간)

1. **선택된 문제 표시**
   - 상단에 "문제 N과 연결 대기중" 배너
   - 없으면 "문제를 먼저 선택하세요" 경고

2. **그룹핑 조건 추가**
   ```typescript
   // PageViewer.tsx 수정
   const handleCreateGroup = () => {
     // Phase 28: 해설창에서 문제 선택 확인
     if (role === 'solution' && !selectedProblem) {
       showToast('문제를 먼저 선택해주세요', 'warning');
       return;  // 그룹핑 차단
     }

     // 기존 그룹 생성 로직...
   };
   ```

3. **매칭 로직 변경**
   ```typescript
   // useAutoMatching.ts 수정
   const onSolutionLabeled = (group: ProblemGroup) => {
     // 기존: FIFO 자동 매칭
     // const oldestPending = pendingRef.current[0];

     // 변경: 선택된 문제와 매칭
     const selectedProblem = selectedProblemRef.current;
     if (!selectedProblem) return;  // 선택 없으면 무시

     createMatch(selectedProblem, group);
     clearSelectedProblem();
   };
   ```

### Phase 28-D: 동기화 및 피드백 (2시간)

1. 매칭 완료 시 양쪽 창 업데이트
2. 토스트 알림
3. 선택 상태 자동 해제

---

## 예상 작업량

| 단계 | 내용 | 예상 시간 |
|------|------|----------|
| 28-A | 상태 관리 + 메시지 타입 | 2시간 |
| 28-B | 문제창 선택 UI | 3시간 |
| 28-C | 해설창 조건부 그룹핑 | 4시간 |
| 28-D | 동기화 + 피드백 | 2시간 |
| **합계** | | **11시간** |

---

## 위험 요소 및 대응

| 위험 | 심각도 | 대응 방안 |
|------|--------|----------|
| 기존 FIFO 모드와 충돌 | 🟡 중간 | 모드 스위치로 선택 가능하게 |
| 창 닫힘 시 선택 유실 | 🟢 낮음 | 로컬스토리지 백업 |
| 동시 선택 충돌 | 🟢 낮음 | 하나만 선택 가능하도록 제한 |
| UX 복잡성 증가 | 🟡 중간 | 명확한 시각적 가이드 |

---

## 기존 FIFO 모드와의 공존

### 옵션 1: 모드 전환 (권장)

```
┌────────────────────────────────┐
│ 매칭 모드: [🔵 순서대로] [선택] │
└────────────────────────────────┘
```

- **순서대로**: 기존 FIFO 방식 (빠른 작업)
- **선택**: 새로운 선택적 매칭 (정확한 매칭)

### 옵션 2: 선택 모드만 유지

- 기존 FIFO 제거
- 항상 문제 선택 후 그룹핑
- 더 직관적이지만 작업 속도 저하 가능

---

## 결론

### ✅ 구현 가능성: **높음**

**근거:**
1. BroadcastChannel 인프라 **이미 존재**
2. 그룹 연결 모델(GroupLink) **이미 존재**
3. 필요한 것은 **선택 상태 관리 + UI 개선**만
4. 기존 코드 80% 재사용 가능

### 🎯 권장 접근 방식

1. **MVP**: 선택적 매칭 기본 기능 (8시간)
   - 문제 클릭 → 선택 상태 전송
   - 해설창에서 조건부 그룹핑

2. **개선**: 모드 전환 추가 (3시간)
   - FIFO vs 선택 모드 스위치
   - 사용자 선호에 따라 선택

---

## 핵심 변경 포인트 요약

```
[변경 1] matching.ts - 메시지 타입 추가
  + PROBLEM_SELECTED
  + PROBLEM_DESELECTED

[변경 2] 문제창 PageViewer/GroupCard - 클릭 이벤트
  + 해설 없는 문제 클릭 시 선택 상태
  + BroadcastChannel 메시지 전송

[변경 3] 해설창 PageViewer - 그룹핑 조건
  + selectedProblem 없으면 그룹핑 차단
  + 상단에 선택된 문제 표시

[변경 4] useAutoMatching.ts - 매칭 로직
  + FIFO 대신 selectedProblem 사용
  + 선택 상태 관리 추가
```

---

*작성일: 2025-12-03*
*Phase 27 완료 후 후속 기능으로 제안*
