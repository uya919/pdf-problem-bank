# 종합 시스템 분석 및 단계별 구현 로드맵

**작성일**: 2025-11-28
**작성자**: Claude Code (Opus)
**버전**: 1.0

---

## 1. 시스템 현황 종합 분석

### 1.1 프로젝트 개요
PDF 문제 라벨링 시스템으로, 학원에서 수학 문제집을 디지털화하고 관리하기 위한 웹 애플리케이션입니다.

### 1.2 기술 스택
| 영역 | 기술 |
|------|------|
| Backend | FastAPI (Python 3.11), PyMuPDF, OpenCV |
| Frontend | React 18 + TypeScript, Vite, TanStack Query, Tailwind CSS |
| 데이터 | 파일 시스템 기반 (JSON + 이미지) |

### 1.3 완료된 Phase 목록

| Phase | 기능 | 상태 |
|-------|------|------|
| 1-5 | 핵심 기능 (블록 검출, GUI, 그룹핑, 내보내기) | ✅ 완료 |
| 6 | UI 리디자인 (Modern React) | ✅ 완료 |
| 7-8 | 문제 명명 시스템 | ✅ 완료 |
| 9 | Quick Wins (UX 개선) | ✅ 완료 |
| 10 | 페이지간 연속성 | ✅ 완료 |
| 11 | 자동화 및 버그 수정 | ✅ 완료 |
| 12 | 코드 리팩토링 | ✅ 완료 |
| 13 | 드래그 성능 최적화 | ✅ 완료 |
| 14 | 대용량 PDF 최적화 | ✅ 완료 |
| 15 | 학습지 빌더 (계획) | 📋 계획됨 |
| 16 | 한글 파일 지원 (HWPX/HML) | ✅ 완료 |
| 17 | 통합 문제 은행 | ✅ 완료 |
| 18 | 문제 삭제 기능 (휴지통) | ✅ 완료 |

### 1.4 현재 발견된 이슈

#### 이슈 #1: HML 파싱 0건 문제
- **원인**: 문제 패턴 불일치 (`[출제의도]` vs `1.`, `1)`)
- **영향**: 내신 시험지 형식 파일 파싱 불가
- **분석 문서**: [44_hml_parsing_analysis_report.md](44_hml_parsing_analysis_report.md)

#### 이슈 #2: HWP 수식 명령어 노출
- **원인**: `rm 1` → "1"로 변환 필요
- **영향**: 보기 번호가 `rm 1` 형태로 표시
- **분석 문서**: [45_hwp_equation_vs_latex_report.md](45_hwp_equation_vs_latex_report.md)

---

## 2. 긴급 수정 사항 (Phase 19)

### 2.1 Phase 19-1: HML 문제 패턴 확장

**목표**: `[출제의도]` 형식 문서 지원

**수정 대상**: `backend/app/services/hangul/problem_extractor.py`

**구현 내용**:
```python
# 기존 PROBLEM_PATTERNS에 추가
PROBLEM_PATTERNS = [
    # 기존 패턴들...
    (r'^\[출제의도\]', 'purpose'),        # 내신 시험지
    (r'^【(\d+)】', 'korean_bracket'),    # 【1】 형식
]
```

**작업 항목**:
- [ ] `[출제의도]` 패턴 추가
- [ ] `[정답]`, `[X.XX점]` 기반 문제 분리 로직 추가
- [ ] 테스트 케이스 작성
- [ ] 기존 파싱 회귀 테스트

**예상 소요**: 2-3시간

---

### 2.2 Phase 19-2: HWP 수식 텍스트 변환

**목표**: `rm 1` → `1` 변환

**수정 대상**: `backend/app/services/hangul/hml_parser.py`

**구현 내용**:
```python
def _clean_equation_text(self, text: str) -> str:
    """HWP 수식 명령어 제거"""
    import re

    # rm/it/bf 제거 (글꼴 지시자)
    text = re.sub(r'\b(rm|it|bf)\s+', '', text)

    # LEFT/RIGHT → 괄호
    text = re.sub(r'\bLEFT\s*\(', '(', text)
    text = re.sub(r'\bRIGHT\s*\)', ')', text)
    text = re.sub(r'\bLEFT\s*\|', '|', text)
    text = re.sub(r'\bRIGHT\s*\|', '|', text)

    # 백틱 제거
    text = text.replace('`', '')

    # 수학 기호 변환
    text = re.sub(r'\bleq\b', '≤', text)
    text = re.sub(r'\bgeq\b', '≥', text)
    text = re.sub(r'\bneq\b', '≠', text)
    text = re.sub(r'\bsqrt\s*', '√', text)

    return text.strip()
```

**작업 항목**:
- [ ] `_clean_equation_text` 메서드 추가
- [ ] EQUATION 태그 처리 시 적용
- [ ] 다양한 수식 테스트
- [ ] 기호 변환 표 정리

**예상 소요**: 1-2시간

---

### 2.3 Phase 19-3: 템플릿 기반 파싱 시스템

**목표**: 문서 형식 자동 감지

**구현 내용**:
```python
class ExamTemplateDetector:
    """시험지 템플릿 자동 감지"""

    TEMPLATES = {
        'standard': {
            'problem_start': r'^(\d+)\.\s',
            'has_answer_section': True,
        },
        'inhwa_exam': {
            'problem_start': r'^\[출제의도\]',
            'inline_answer': r'\[정답\]\s*([①②③④⑤])',
            'points': r'\[(\d+\.?\d*)점\]',
        },
        'bracket_number': {
            'problem_start': r'^【(\d+)】',
        }
    }

    def detect_template(self, full_text: str) -> str:
        if '[출제의도]' in full_text:
            return 'inhwa_exam'
        if '【' in full_text:
            return 'bracket_number'
        return 'standard'
```

**작업 항목**:
- [ ] `ExamTemplateDetector` 클래스 생성
- [ ] 템플릿별 파싱 로직 분리
- [ ] 파싱 결과에 템플릿 정보 포함
- [ ] 사용자 템플릿 수동 선택 UI (선택적)

**예상 소요**: 3-4시간

---

## 3. 단기 개선 계획 (Phase 20-21)

### 3.1 Phase 20: 파싱 품질 대시보드

**목표**: 파싱 결과 검증 및 피드백

**기능**:
1. 파싱 성공률 표시
2. 누락된 문제/정답 하이라이트
3. 수동 교정 인터페이스
4. 파싱 로그 저장

**화면 구성**:
```
┌─────────────────────────────────────────┐
│  파싱 결과 대시보드                      │
├─────────────────────────────────────────┤
│  파일: 인화여고_수학상.hml               │
│  검출 문제: 20개                         │
│  정답 매칭: 18개 (90%)                   │
│  배점 감지: 20개 (100%)                  │
├─────────────────────────────────────────┤
│  [⚠️ 정답 누락]                          │
│  - 문제 5: 정답 없음 → [수동 입력]       │
│  - 문제 12: 정답 없음 → [수동 입력]      │
├─────────────────────────────────────────┤
│  [원본 미리보기]  [파싱 결과]  [저장]    │
└─────────────────────────────────────────┘
```

**작업 항목**:
- [ ] 파싱 결과 상세 API 설계
- [ ] 대시보드 UI 컴포넌트 개발
- [ ] 수동 교정 기능 구현
- [ ] 파싱 로그 저장 시스템

**예상 소요**: 8-10시간

---

### 3.2 Phase 21: 수식 렌더링 개선

**목표**: HWP 수식을 예쁘게 표시

**옵션**:
1. **옵션 A**: MathJax/KaTeX로 LaTeX 렌더링
2. **옵션 B**: 수식을 이미지로 추출 (HWP 원본 유지)
3. **옵션 C**: 단순 텍스트 변환 (현재 방식 개선)

**권장**: 옵션 C (단기) → 옵션 A (중기)

**LaTeX 변환 예시**:
```
HWP: {5} over {4}  →  LaTeX: \frac{5}{4}  →  표시: 5/4
HWP: sqrt{2}       →  LaTeX: \sqrt{2}     →  표시: √2
HWP: x^2           →  LaTeX: x^{2}        →  표시: x²
```

**작업 항목**:
- [ ] HWP→LaTeX 변환기 구현
- [ ] KaTeX 프론트엔드 통합
- [ ] 수식 미리보기 컴포넌트
- [ ] 변환 실패 시 원본 표시

**예상 소요**: 6-8시간

---

## 4. 중기 개선 계획 (Phase 22-25)

### 4.1 Phase 22: 문제 은행 검색 강화

**목표**: 고급 검색 및 필터링

**기능**:
- 전문 검색 (Full-text search)
- 태그 기반 필터링
- 난이도 필터
- 출처 필터 (학교, 연도, 학기)
- 유사 문제 찾기

**기술 옵션**:
| 옵션 | 장점 | 단점 |
|------|------|------|
| SQLite FTS5 | 간단, 로컬 | 확장성 제한 |
| Elasticsearch | 강력한 검색 | 별도 서버 필요 |
| Meilisearch | 가벼움, 빠름 | 한국어 지원 제한 |

**권장**: SQLite FTS5 (초기) → Meilisearch (확장 시)

---

### 4.2 Phase 23: 학습지 빌더 재설계

**목표**: Phase 15 계획 실행 + 개선

**기능**:
1. 드래그앤드롭 문제 배치
2. 템플릿 선택 (A4/B4, 1단/2단)
3. 문제 번호 자동 재배열
4. PDF/HWP 내보내기
5. 정답지 자동 생성

**화면 구성**:
```
┌───────────────────────────────────────────────────────┐
│  학습지 빌더                                           │
├───────────────────────────────────────────────────────┤
│ 좌측 패널     │  중앙 편집 영역      │  우측 설정      │
│ ┌───────────┐ │  ┌────────────────┐  │ ┌────────────┐ │
│ │ 문제 은행  │ │  │    A4 미리보기   │  │ │ 템플릿    │ │
│ │ - 검색    │ │  │  ┌──────────┐  │  │ │ - A4 1단  │ │
│ │ - 필터    │ │  │  │ 문제 1   │  │  │ │ - A4 2단  │ │
│ │ - 목록    │ │  │  └──────────┘  │  │ │ - B4 2단  │ │
│ │           │ │  │  ┌──────────┐  │  │ ├───────────┤ │
│ │ [문제1]   │ │  │  │ 문제 2   │  │  │ │ 스타일    │ │
│ │ [문제2]   │ │  │  └──────────┘  │  │ │ - 폰트    │ │
│ │ [문제3]   │ │  │                │  │ │ - 여백    │ │
│ └───────────┘ │  └────────────────┘  │ └────────────┘ │
│               │  [PDF 내보내기] [HWP] │               │
└───────────────────────────────────────────────────────┘
```

---

### 4.3 Phase 24: 이미지 OCR 통합

**목표**: 스캔 문서 지원

**기술 옵션**:
| 기술 | 한국어 지원 | 수식 지원 | 비용 |
|------|------------|----------|------|
| Tesseract | ⚠️ 보통 | ❌ 약함 | 무료 |
| Google Vision | ✅ 좋음 | ✅ 좋음 | 유료 |
| Naver Clova | ✅ 매우 좋음 | ⚠️ 보통 | 유료 |
| PaddleOCR | ✅ 좋음 | ✅ 좋음 | 무료 |

**권장**: PaddleOCR (무료, 한국어 지원)

---

### 4.4 Phase 25: 협업 기능

**목표**: 다중 사용자 지원

**기능**:
- 사용자 인증 (OAuth 또는 간단한 로그인)
- 작업 이력 추적
- 동시 편집 방지 (락킹)
- 작업 할당

**구현 순서**:
1. 기본 사용자 시스템
2. 작업 로그
3. 락킹 메커니즘

---

## 5. 장기 비전 (Phase 26+)

### 5.1 AI 기반 자동화

| 기능 | 설명 | 기술 |
|------|------|------|
| 자동 문제 분류 | 단원/유형 자동 태깅 | NLP 분류기 |
| 난이도 예측 | 문제 난이도 자동 추정 | ML 모델 |
| 오답 분석 | 학생 오답 패턴 분석 | 통계 분석 |
| 유사 문제 추천 | 복습용 문제 추천 | 벡터 유사도 |

### 5.2 모바일 앱

- React Native 또는 Flutter
- 문제 풀이 인터페이스
- 학생용 앱

### 5.3 LMS 연동

- 학원 관리 시스템 API 연동
- 학생 성적 추적
- 자동 학습지 배정

---

## 6. 우선순위 및 일정

### 6.1 즉시 실행 (이번 주)

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 1 | Phase 19-1: 문제 패턴 확장 | 2-3시간 |
| 2 | Phase 19-2: 수식 텍스트 변환 | 1-2시간 |
| 3 | 테스트 및 검증 | 1시간 |

### 6.2 단기 (1-2주)

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 4 | Phase 19-3: 템플릿 감지 | 3-4시간 |
| 5 | Phase 20: 파싱 대시보드 | 8-10시간 |

### 6.3 중기 (1개월)

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 6 | Phase 21: 수식 렌더링 | 6-8시간 |
| 7 | Phase 22: 검색 강화 | 10-12시간 |
| 8 | Phase 23: 학습지 빌더 | 15-20시간 |

---

## 7. 기술 부채 정리

### 7.1 코드 품질

| 항목 | 현황 | 권장 작업 |
|------|------|----------|
| 테스트 커버리지 | 낮음 | 핵심 로직 테스트 추가 |
| 타입 안전성 | 부분적 | TypeScript strict 모드 |
| 에러 처리 | 기본 | 사용자 친화적 에러 메시지 |
| 로깅 | 최소 | 구조화된 로깅 시스템 |

### 7.2 성능

| 항목 | 현황 | 권장 작업 |
|------|------|----------|
| 대용량 PDF | Phase 14로 개선 | 모니터링 계속 |
| 이미지 캐싱 | 기본 | CDN 또는 서비스 워커 |
| API 응답 | 양호 | 필요시 Redis 캐시 |

### 7.3 보안

| 항목 | 현황 | 권장 작업 |
|------|------|----------|
| 인증 | 없음 | Phase 25에서 구현 |
| 파일 업로드 | 기본 검증 | MIME 타입 검증 강화 |
| CORS | 개발 모드 | 프로덕션 설정 필요 |

---

## 8. 결론 및 권장 사항

### 8.1 즉각 조치 필요

1. **Phase 19-1, 19-2 즉시 구현**: HML 파싱 문제 해결
2. 기존 HML 파일로 회귀 테스트 수행

### 8.2 전략적 방향

1. **안정성 우선**: 새 기능보다 기존 기능 안정화
2. **사용자 피드백 반영**: 파싱 대시보드로 품질 가시화
3. **점진적 확장**: 검색 → 학습지 → 협업 순서로 확장

### 8.3 다음 단계

```
[현재 위치]
     ↓
Phase 19: HML 파싱 수정 (긴급)
     ↓
Phase 20: 파싱 대시보드 (품질 관리)
     ↓
Phase 21: 수식 렌더링 (UX 개선)
     ↓
Phase 22: 검색 강화 (기능 확장)
     ↓
Phase 23: 학습지 빌더 (핵심 기능)
```

---

## 부록 A: 파일 구조 요약

```
backend/app/
├── main.py                    # FastAPI 앱
├── config.py                  # 설정
├── routers/
│   ├── pdf.py                 # PDF 업로드/처리
│   ├── blocks.py              # 블록 API
│   ├── export.py              # 내보내기
│   ├── problems.py            # 문제 은행 API
│   └── hangul.py              # 한글 파일 API
└── services/
    ├── block_detector.py      # 블록 검출
    ├── pdf_processor.py       # PDF 처리
    └── hangul/
        ├── hwpx_parser.py     # HWPX 파서
        ├── hml_parser.py      # HML 파서
        └── problem_extractor.py # 문제 추출

frontend/src/
├── api/                       # API 클라이언트
├── components/
│   ├── problem-bank/          # 문제 은행 UI
│   ├── hangul/                # 한글 파일 UI
│   └── labeling/              # 라벨링 UI
├── pages/                     # 페이지 컴포넌트
└── hooks/                     # 커스텀 훅
```

---

## 부록 B: API 엔드포인트 요약

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | /api/upload | PDF 업로드 |
| GET | /api/documents | 문서 목록 |
| GET | /api/pages/{doc_id}/{page} | 페이지 이미지 |
| GET | /api/blocks/{doc_id}/{page} | 블록 데이터 |
| POST | /api/groups | 그룹 저장 |
| POST | /api/export/{doc_id} | 내보내기 |
| POST | /api/hangul/upload | 한글 파일 업로드 |
| GET | /api/hangul/documents | 한글 문서 목록 |
| GET | /api/hangul/problems/{doc_id} | 파싱된 문제 |
| GET | /api/problems | 문제 은행 목록 |
| POST | /api/problems/bulk-delete | 문제 삭제 |
| GET | /api/problems/trash | 휴지통 |

---

*작성: Claude Code (Opus)*
*날짜: 2025-11-28*
