# ğŸš¨ ê¸´ê¸‰ ë²„ê·¸ ë¦¬í¬íŠ¸: ê·¸ë£¹ ID ì¶©ëŒë¡œ ì¸í•œ ë°ì´í„° ìœ ì‹¤

**ì‘ì„±ì¼**: 2025-12-04
**ì‹¬ê°ë„**: ğŸ”´ **Critical - ë°ì´í„° ìœ ì‹¤**
**ì˜í–¥ ë²”ìœ„**: ëª¨ë“  ë‹¤ì¤‘ í˜ì´ì§€ ë¼ë²¨ë§ ì‘ì—…

---

## 1. ë²„ê·¸ ìš”ì•½

### ì¬í˜„ ì‹œë‚˜ë¦¬ì˜¤
```
1. 10í˜ì´ì§€ì—ì„œ ê·¸ë£¹í•‘ â†’ "L1", "L2", "L3" ìƒì„± (7ë¬¸ì œ)
2. í•´ì„¤ ì—°ê²° ì™„ë£Œ
3. 18í˜ì´ì§€ë¡œ ì´ë™
4. 18í˜ì´ì§€ì—ì„œ ê·¸ë£¹í•‘ â†’ "L1", "L2" ìƒì„± (ê°™ì€ ID!)
5. ğŸ’¥ 10í˜ì´ì§€ ì‘ì—… ì‚¬ë¼ì§!
```

### ê·¼ë³¸ ì›ì¸
**ê·¸ë£¹ IDê°€ í˜ì´ì§€ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ìƒì„±ë˜ì–´ ì¶©ëŒ ë°œìƒ**

```
í˜ì´ì§€ 10: L1, L2, L3, L4, L5, L6, L7
í˜ì´ì§€ 18: L1, L2  â† ê°™ì€ ID!
           â†“
ì„¸ì…˜ ë™ê¸°í™” ì‹œ ë®ì–´ì“°ê¸° â†’ 10í˜ì´ì§€ ë°ì´í„° ìœ ì‹¤
```

---

## 2. ê¸°ìˆ ì  ë¶„ì„

### 2.1 ë¬¸ì œì˜ ì½”ë“œ (PageViewer.tsx:412-422)

```typescript
const handleCreateGroup = async () => {
  const column = firstBlock.column;  // "L" ë˜ëŠ” "R"

  // âš ï¸ í˜„ì¬ í˜ì´ì§€ì˜ localGroupsì—ì„œë§Œ ê²€ìƒ‰
  const existingGroups = localGroups.filter((g) => g.column === column);
  const maxNumber = existingGroups.reduce((max, g) => {
    const match = g.id.match(/\d+$/);
    if (match) {
      return Math.max(max, parseInt(match[0], 10));
    }
    return max;
  }, 0);

  // ê²°ê³¼: "L1", "L2"... (í˜ì´ì§€ë§ˆë‹¤ 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘!)
  const newGroupId = `${column}${maxNumber + 1}`;
};
```

### 2.2 ë™ê¸°í™” ì‹œ ë®ì–´ì“°ê¸° (sync_manager.py:63-172)

```python
def sync_problems_to_session(self, session: WorkSession) -> SyncResult:
    all_groups = {}  # Dictionary

    for groups_file in sorted(groups_dir.glob("page_*_groups.json")):
        page_index = int(groups_file.stem.split("_")[1])

        for group in data.get("groups", []):
            group_id = group.get("id")
            if group_id:
                # âš ï¸ ê°™ì€ group_idë©´ ë®ì–´ì“°ê¸°!
                all_groups[group_id] = {
                    "group": group,
                    "pageIndex": page_index,
                }
```

### 2.3 ë°ì´í„° íë¦„ (ë²„ê·¸ ë°œìƒ ê³¼ì •)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: í˜ì´ì§€ 10ì—ì„œ ì‘ì—…                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ localGroups = []                                            â”‚
â”‚ ê·¸ë£¹ ìƒì„±: L1, L2, L3, L4, L5, L6, L7                       â”‚
â”‚ â†’ page_0010_groups.jsonì— ì €ì¥                              â”‚
â”‚ â†’ session.problemsì— ì¶”ê°€                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: í˜ì´ì§€ 18ë¡œ ì´ë™                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ localGroups = [] (ì´ˆê¸°í™”ë¨!)                                â”‚
â”‚ ê·¸ë£¹ ìƒì„±: L1, L2 (ë‹¤ì‹œ 1ë¶€í„° ì‹œì‘!)                         â”‚
â”‚ â†’ page_0018_groups.jsonì— ì €ì¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ì„¸ì…˜ ë™ê¸°í™” (fullSync)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ page_0010_groups.json ì½ìŒ:                                 â”‚
â”‚   all_groups["L1"] = {pageIndex: 10, ...}                   â”‚
â”‚   all_groups["L2"] = {pageIndex: 10, ...}                   â”‚
â”‚                                                             â”‚
â”‚ page_0018_groups.json ì½ìŒ:                                 â”‚
â”‚   all_groups["L1"] = {pageIndex: 18, ...}  â† ë®ì–´ì“°ê¸°!      â”‚
â”‚   all_groups["L2"] = {pageIndex: 18, ...}  â† ë®ì–´ì“°ê¸°!      â”‚
â”‚                                                             â”‚
â”‚ ğŸ’¥ ê²°ê³¼: 10í˜ì´ì§€ì˜ L1, L2 ë°ì´í„° ìœ ì‹¤                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ì˜í–¥ ë¶„ì„

### 3.1 ë°ì´í„° ìœ ì‹¤ ë²”ìœ„

| ìƒí™© | ì˜í–¥ |
|------|------|
| ê°™ì€ í˜ì´ì§€ ë‚´ ì‘ì—… | âœ… ì•ˆì „ |
| ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ê°™ì€ ì»¬ëŸ¼ ì‘ì—… | ğŸ”´ **ë°ì´í„° ìœ ì‹¤** |
| L ì»¬ëŸ¼ê³¼ R ì»¬ëŸ¼ ë¶„ë¦¬ ì‘ì—… | âš ï¸ ì¼ë¶€ ì•ˆì „ (IDê°€ ë‹¤ë¥´ë©´) |

### 3.2 ì†ì‹¤ë˜ëŠ” ë°ì´í„°

- ì´ì „ í˜ì´ì§€ì˜ ê·¸ë£¹ ì •ë³´ (session.problemsì—ì„œ)
- í•´ì„¤ ì—°ê²° ì •ë³´ (session.linksì—ì„œ)
- ë¬¸ì œ ë²ˆí˜¸ ë§¤í•‘

### 3.3 groups.json íŒŒì¼ì€ ì•ˆì „

```
dataset_root/
â””â”€ documents/{doc_id}/
   â””â”€ groups/
      â”œâ”€ page_0010_groups.json  â† íŒŒì¼ ìì²´ëŠ” ìœ ì§€ë¨
      â””â”€ page_0018_groups.json  â† íŒŒì¼ ìì²´ëŠ” ìœ ì§€ë¨
```

**ê°œë³„ íŒŒì¼ì€ ë³´ì¡´**ë˜ì§€ë§Œ, **ì„¸ì…˜ì—ì„œ ì°¸ì¡°ê°€ ì†ì‹¤**ë¨

---

## 4. í•´ê²° ë°©ì•ˆ

### 4.1 ì¦‰ì‹œ ìˆ˜ì • í•„ìš” (Phase 47)

#### ìˆ˜ì • 1: ê·¸ë£¹ IDì— í˜ì´ì§€ ì •ë³´ í¬í•¨

**íŒŒì¼**: `frontend/src/pages/PageViewer.tsx`

```typescript
// Before (ìœ„í—˜)
const newGroupId = `${column}${maxNumber + 1}`;
// ê²°ê³¼: "L1", "L2"

// After (ì•ˆì „)
const newGroupId = `p${currentPage}_${column}${maxNumber + 1}`;
// ê²°ê³¼: "p10_L1", "p10_L2", "p18_L1", "p18_L2"
```

#### ìˆ˜ì • 2: ë™ê¸°í™” ì‹œ ë³µí•© í‚¤ ì‚¬ìš©

**íŒŒì¼**: `backend/app/services/sync_manager.py`

```python
# Before (ìœ„í—˜)
all_groups[group_id] = {...}

# After (ì•ˆì „)
composite_key = f"{page_index}:{group_id}"
all_groups[composite_key] = {
    "group": group,
    "pageIndex": page_index,
    "originalGroupId": group_id
}
```

#### ìˆ˜ì • 3: Upsert ì¡°ê±´ ê°•í™”

**íŒŒì¼**: `backend/app/routers/work_sessions.py`

```python
# Before (ìœ„í—˜)
existing = next((p for p in session.problems
                 if p.groupId == request.groupId), None)

# After (ì•ˆì „)
existing = next((p for p in session.problems
                 if p.groupId == request.groupId
                 and p.pageIndex == request.pageIndex), None)
```

### 4.2 ê¸°ì¡´ ë°ì´í„° ë³µêµ¬

ê¸°ì¡´ ê·¸ë£¹ IDë¥¼ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ í•„ìš”:

```python
# ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì‹œ
for groups_file in groups_dir.glob("page_*_groups.json"):
    page_index = extract_page_index(groups_file)
    data = load_json(groups_file)

    for group in data["groups"]:
        old_id = group["id"]  # "L1"
        new_id = f"p{page_index}_{old_id}"  # "p10_L1"
        group["id"] = new_id

    save_json(groups_file, data)
```

---

## 5. ì„ì‹œ í•´ê²°ì±… (ì§€ê¸ˆ ë‹¹ì¥)

### ì‚¬ìš©ì ê°€ì´ë“œ

1. **ê° í˜ì´ì§€ ì‘ì—… í›„ ì„¸ì…˜ ì €ì¥ í™•ì¸**
2. **ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì „ ë°±ì—…**
   ```
   dataset_root/work_sessions/ í´ë” ë³µì‚¬
   ```
3. **ìˆ˜ë™ ë³µêµ¬ ë°©ë²•**
   - `page_XXXX_groups.json` íŒŒì¼ í™•ì¸ (ë°ì´í„°ëŠ” ìˆìŒ)
   - ì„¸ì…˜ íŒŒì¼ê³¼ ë¹„êµí•˜ì—¬ ëˆ„ë½ëœ ê·¸ë£¹ ìˆ˜ë™ ì¶”ê°€

---

## 6. ìˆ˜ì • ìš°ì„ ìˆœìœ„

| ìˆœì„œ | ì‘ì—… | íŒŒì¼ | ì˜ˆìƒ ì‹œê°„ |
|------|------|------|----------|
| 1 | ê·¸ë£¹ ID í˜•ì‹ ë³€ê²½ | PageViewer.tsx | 15ë¶„ |
| 2 | ë™ê¸°í™” ë¡œì§ ìˆ˜ì • | sync_manager.py | 20ë¶„ |
| 3 | Upsert ì¡°ê±´ ê°•í™” | work_sessions.py | 10ë¶„ |
| 4 | ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ | ìƒˆ ìŠ¤í¬ë¦½íŠ¸ | 30ë¶„ |
| 5 | í…ŒìŠ¤íŠ¸ | - | 20ë¶„ |

**ì´ ì˜ˆìƒ ì†Œìš”: 1.5ì‹œê°„**

---

## 7. í…ŒìŠ¤íŠ¸ ê³„íš

### ìˆ˜ì • í›„ í™•ì¸ ì‚¬í•­

- [ ] í˜ì´ì§€ 10ì—ì„œ ê·¸ë£¹ ìƒì„± â†’ ID í˜•ì‹ í™•ì¸ ("p10_L1")
- [ ] í˜ì´ì§€ 18ì—ì„œ ê·¸ë£¹ ìƒì„± â†’ ID í˜•ì‹ í™•ì¸ ("p18_L1")
- [ ] ì„¸ì…˜ ë™ê¸°í™” í›„ ë‘ í˜ì´ì§€ ë°ì´í„° ëª¨ë‘ ì¡´ì¬ í™•ì¸
- [ ] ê¸°ì¡´ ì„¸ì…˜ ë¡œë“œ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ìƒ ë™ì‘ í™•ì¸

---

## 8. ê²°ë¡ 

### ë²„ê·¸ ì›ì¸
```
ê·¸ë£¹ ID = ì»¬ëŸ¼ + ìˆœë²ˆ (ì˜ˆ: "L1")
         â†“
í˜ì´ì§€ë§ˆë‹¤ ìˆœë²ˆì´ 1ë¶€í„° ì‹œì‘
         â†“
ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ê°™ì€ ID ìƒì„±
         â†“
ì„¸ì…˜ ë™ê¸°í™” ì‹œ Dictionary ë®ì–´ì“°ê¸°
         â†“
ğŸ’¥ ì´ì „ í˜ì´ì§€ ë°ì´í„° ìœ ì‹¤
```

### í•´ê²°ì±…
```
ê·¸ë£¹ ID = í˜ì´ì§€ + ì»¬ëŸ¼ + ìˆœë²ˆ (ì˜ˆ: "p10_L1")
         â†“
ì „ì—­ì ìœ¼ë¡œ ê³ ìœ í•œ ID ë³´ì¥
         â†“
ë™ê¸°í™” ì‹œ ì¶©ëŒ ì—†ìŒ
         â†“
âœ… ë°ì´í„° ì•ˆì „
```

---

**ì´ ë²„ê·¸ëŠ” ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?**

---

*ë²„ê·¸ ë¦¬í¬íŠ¸ ì‘ì„±: Claude Opus*
*ë¶„ì„ ì™„ë£Œ: 2025-12-04*
