# Phase 18-B 개선: 휴지통(Soft Delete) 시스템 구현 계획

**작성일**: 2025-11-28
**작성자**: Claude Code (Opus)
**상태**: 계획 완료, 승인 대기

---

## 1. 현재 문제점

### 1.1 API 405 에러
- `POST /api/hangul/problems/bulk-delete`가 405 Method Not Allowed 반환
- **원인**: FastAPI 라우터 경로 매칭 순서 문제
  - `/problems/{problem_id}`가 `/problems/bulk-delete`보다 먼저 매칭됨
  - `bulk-delete`가 `{problem_id}`로 인식되어 잘못된 핸들러 호출

### 1.2 UX 문제
- 현재: "삭제" 타이핑 확인 방식 → 번거롭고 사용자 불편
- 실수로 삭제 시 복구 불가능 (Hard Delete)
- 삭제 확인 다이얼로그가 번거로움

---

## 2. 개선 방향: 휴지통 시스템

### 2.1 개념
```
[문제 목록] ──(삭제)──> [휴지통] ──(영구삭제)──> 완전 삭제
                         │
                         └──(복원)──> [문제 목록]
```

### 2.2 장점
| 항목 | Hard Delete | Soft Delete (휴지통) |
|------|-------------|---------------------|
| 복구 가능 | ❌ | ✅ |
| 확인 절차 | "삭제" 타이핑 필요 | 간단한 클릭 |
| 실수 방지 | 확인 다이얼로그 의존 | 언제든 복원 가능 |
| 데이터 안전 | 낮음 | 높음 |

---

## 3. 구현 상세

### 3.1 데이터 구조 변경

#### 3.1.1 문제 레코드에 삭제 상태 추가
```json
{
  "id": "uuid",
  "number": "1",
  "content_text": "...",
  "deleted_at": null,        // null = 활성, ISO 날짜 = 삭제됨
  "deleted_reason": null,    // 선택적: 삭제 사유
  ...
}
```

#### 3.1.2 인덱스 구조 변경
```json
{
  "problems": [...],        // 활성 문제만
  "trash": [...],           // 휴지통 (삭제된 문제)
  "updated_at": "..."
}
```

### 3.2 백엔드 API

#### 3.2.1 기존 API 수정
| 메서드 | 경로 | 변경 내용 |
|--------|------|----------|
| GET | /problems | 활성 문제만 반환 (기본) |
| DELETE | /problems/{id} | Hard Delete → Soft Delete (휴지통 이동) |
| POST | /problems/bulk-delete | 경로를 /problems/move-to-trash로 변경 |

#### 3.2.2 새 API 추가
| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /trash | 휴지통 목록 조회 |
| GET | /trash/stats | 휴지통 통계 (개수, 용량 등) |
| POST | /trash/restore | 선택 항목 복원 |
| POST | /trash/restore-all | 전체 복원 |
| DELETE | /trash/{id} | 단일 영구 삭제 |
| DELETE | /trash/empty | 휴지통 비우기 (전체 영구 삭제) |

### 3.3 프론트엔드 UI

#### 3.3.1 메인 페이지 변경
```
┌──────────────────────────────────────────────────────┐
│ 통합 문제은행                                          │
├──────────────────────────────────────────────────────┤
│ [문제 목록]  [휴지통 (3)]                              │  ← 탭 추가
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │
│  │ #1  │ │ #2  │ │ #3  │ │ #4  │  ...              │
│  └─────┘ └─────┘ └─────┘ └─────┘                   │
│                                                      │
└──────────────────────────────────────────────────────┘
```

#### 3.3.2 휴지통 탭 UI
```
┌──────────────────────────────────────────────────────┐
│ 휴지통 (3개 항목)                      [휴지통 비우기]  │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌─────────────────────────────────────────────────┐ │
│  │ ☑ #1 (수학 - 3일 전 삭제)          [복원] [삭제]│ │
│  │ ☑ #2 (수학 - 1일 전 삭제)          [복원] [삭제]│ │
│  │ □ #3 (영어 - 오늘 삭제)            [복원] [삭제]│ │
│  └─────────────────────────────────────────────────┘ │
│                                                      │
│ ───────────────────────────────────────────────────  │
│ [2개 선택됨]     [선택 복원]  [선택 삭제]              │
└──────────────────────────────────────────────────────┘
```

#### 3.3.3 삭제 플로우 변경
**현재 (Hard Delete)**:
```
선택 → 삭제 클릭 → 확인 다이얼로그 ("삭제" 타이핑) → 영구 삭제
```

**변경 후 (Soft Delete)**:
```
선택 → 휴지통 이동 클릭 → (확인 없이) 휴지통으로 이동 → 알림 토스트 표시
```

#### 3.3.4 플로팅 액션 바 변경
```
현재: [3개 선택됨] | [전체 선택] [선택 취소] | [삭제]
변경: [3개 선택됨] | [전체 선택] [선택 취소] | [휴지통으로 이동]
```

### 3.4 자동 삭제 정책 (선택 사항)
- 휴지통에 30일 이상 보관된 항목 자동 영구 삭제
- 서버 시작 시 또는 스케줄러로 정리
- MVP에서는 생략 가능

---

## 4. 구현 단계

### Phase 18-B-1: 백엔드 API 수정 (1.5시간)
1. 라우터 경로 순서 수정 (405 에러 해결)
2. 문제 레코드에 `deleted_at` 필드 추가
3. 인덱스에 `trash` 배열 추가
4. 기존 DELETE API를 Soft Delete로 변경
5. 휴지통 API 구현 (GET /trash, POST /restore, DELETE /empty)

### Phase 18-B-2: 프론트엔드 API 클라이언트 (30분)
1. 새 API 타입 정의
2. trashApi 함수 추가

### Phase 18-B-3: 프론트엔드 UI 변경 (2시간)
1. 탭 UI 추가 (문제 목록 / 휴지통)
2. 휴지통 목록 컴포넌트
3. 복원/영구삭제 기능
4. 휴지통 비우기 다이얼로그 (이건 확인 필요)
5. 플로팅 액션 바 텍스트 변경

### Phase 18-B-4: 테스트 및 마이그레이션 (1시간)
1. 기존 데이터 마이그레이션 (trash 배열 추가)
2. 기능 테스트

---

## 5. API 상세 명세

### 5.1 GET /trash
```json
// Response
{
  "items": [
    {
      "id": "uuid",
      "number": "1",
      "content_text": "...",
      "metadata": {...},
      "deleted_at": "2025-11-28T10:00:00",
      "days_in_trash": 3
    }
  ],
  "total": 3
}
```

### 5.2 POST /trash/restore
```json
// Request
{
  "problem_ids": ["id1", "id2"]
}

// Response
{
  "success": true,
  "restored_count": 2,
  "restored_ids": ["id1", "id2"],
  "message": "2개 문제가 복원되었습니다."
}
```

### 5.3 DELETE /trash/empty
```json
// Request
{
  "confirm": "EMPTY_TRASH"  // 영구 삭제이므로 확인 필요
}

// Response
{
  "success": true,
  "deleted_count": 3,
  "message": "휴지통이 비워졌습니다. (3개 영구 삭제)"
}
```

---

## 6. UI 컴포넌트 구조

```
IntegratedProblemBankPage
├── TabBar (문제 목록 | 휴지통)
├── ProblemListTab (기존)
│   ├── FilterSection
│   ├── ProblemGrid
│   │   └── ProblemCard (체크박스 + 휴지통 이동)
│   └── SelectionActionBar ("휴지통으로 이동" 버튼)
│
└── TrashTab (새로 추가)
    ├── TrashHeader (개수 + 휴지통 비우기 버튼)
    ├── TrashList
    │   └── TrashItem (체크박스 + 복원/삭제 버튼)
    └── TrashActionBar (선택 복원 / 선택 삭제)
```

---

## 7. 예상 소요 시간

| 단계 | 내용 | 시간 |
|------|------|------|
| 18-B-1 | 백엔드 API | 1.5시간 |
| 18-B-2 | 프론트엔드 API | 30분 |
| 18-B-3 | 프론트엔드 UI | 2시간 |
| 18-B-4 | 테스트 | 1시간 |
| **합계** | | **5시간** |

---

## 8. 위험 요소

| 위험 | 영향 | 대응 |
|------|------|------|
| 기존 데이터 마이그레이션 | 중간 | index.json에 trash 배열 추가 |
| 휴지통 용량 증가 | 낮음 | 자동 삭제 정책 (30일) - MVP 이후 |
| 복원 시 중복 ID | 낮음 | ID 유지하므로 충돌 없음 |

---

## 9. 삭제 확인 다이얼로그 변경

### 9.1 휴지통으로 이동 (확인 불필요)
- 클릭 즉시 이동
- Toast 알림: "3개 문제가 휴지통으로 이동되었습니다. [되돌리기]"
- 되돌리기 클릭 시 즉시 복원

### 9.2 휴지통 비우기 (확인 필요)
- 영구 삭제이므로 확인 다이얼로그 표시
- 단, "삭제" 타이핑 대신 간단한 확인 버튼
```
┌───────────────────────────────────────┐
│      휴지통 비우기                     │
│                                       │
│  휴지통의 3개 항목이 영구 삭제됩니다.   │
│  이 작업은 되돌릴 수 없습니다.          │
│                                       │
│     [취소]        [영구 삭제]          │
└───────────────────────────────────────┘
```

---

## 10. 결론

**휴지통 시스템의 핵심 가치**:
1. **안전성**: 실수로 삭제해도 복구 가능
2. **편의성**: 번거로운 확인 절차 제거
3. **유연성**: 삭제 후에도 마음 변경 가능

승인 후 Phase 18-B-1부터 순차 진행합니다.

---

*작성: Claude Code (Opus)*
*날짜: 2025-11-28*
