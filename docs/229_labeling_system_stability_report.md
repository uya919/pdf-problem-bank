# PDF 라벨링 시스템 v2.0 - 종합 안정성 분석 보고서

**문서 번호**: 229
**작성일**: 2025-12-07
**목적**: 시스템 안정성 분석 및 개선 권고

---

## Executive Summary

PDF 문제은행 시스템은 **복잡한 다단계 워크플로우를 처리하는 확장 가능한 아키텍처**를 가지고 있으나, **데이터 동기화, 에러 처리, 경쟁 조건(Race Condition) 관리 측면에서 안정성 위험**이 존재합니다.

**전체 안정성 점수: 6.1/10** (중간 수준)

---

## 1. 파일별 상세 분석

### 1.1 백엔드 라우터

#### export.py (1200줄)

| 항목 | 상태 |
|------|------|
| 역할 | 그룹 데이터를 문제 이미지로 내보내기 |
| 점수 | 6/10 |

**문제점**:
1. **중복 로직 (DRY 위반)**: 3개 함수가 거의 동일한 이미지 처리 로직 포함
2. **메모리 누수 위험**: Image.open() 후 close() 미호출
3. **경쟁 조건**: groups.json 읽기 → 처리 → 쓰기 사이 취약
4. **파일 경로 검증 부족**: 조용한 실패로 사용자가 모름
5. **메타데이터 저장 후 보증 없음**: 이미지 저장 실패 시 고아 파일 생성

---

#### blocks.py (510줄)

| 항목 | 상태 |
|------|------|
| 역할 | 블록 데이터 및 그룹 조회/저장 |
| 점수 | 7/10 |

**문제점**:
1. 불완전한 에러 처리 (기본값 반환 → 데이터 손실 감지 안됨)
2. On-Demand 이미지 변환 시 캐싱 부재 → 서버 부하

---

#### pdf.py (336줄)

| 항목 | 상태 |
|------|------|
| 역할 | PDF 업로드 및 점진적 처리 |
| 점수 | 6/10 |

**문제점**:
1. document_id 충돌 처리 부재 → 기존 문서 덮어쓰기 가능
2. 백그라운드 작업 실패 이유 저장 안됨
3. 메타데이터 저장 타이밍 이슈

---

#### work_sessions.py (838줄)

| 항목 | 상태 |
|------|------|
| 역할 | 작업 세션 CRUD + 문제-해설 연결 |
| 점수 | 6/10 |

**문제점**:
1. **동기화 버그 위험**: 링크 생성 시 2-3단계 사이 장애 가능
2. **Upsert 중복 키 처리**: pageIndex 변경 시 새 문제로 간주
3. **reset_session 롤백 불가**: groups.json 삭제 실패 시

---

### 1.2 프론트엔드 컴포넌트

#### PageViewer.tsx (1335줄)

| 항목 | 상태 |
|------|------|
| 역할 | 문제 라벨링 핵심 UI |
| 점수 | 5/10 |

**문제점**:
1. **상태 관리 복잡도**: 17개 useState 훅 (State Hell)
2. **레이스 컨디션**: 페이지 전환 시 saveGroups 완료 전 덮어쓰기
3. **자동저장 타이밍 이슈**: isInitialLoadRef 설정 타이밍 불명확
4. **exportWithRetry 경합 조건**: 100ms 고정 지연은 환경에 따라 부족

---

#### GroupPanel.tsx (812줄)

| 항목 | 상태 |
|------|------|
| 역할 | 그룹 목록 및 편집 UI |
| 점수 | 7/10 |

**문제점**:
1. 자동 확정 조건 불명확
2. displayName 생성 로직 중복
3. useMemo 미적용으로 성능 저하

---

#### PageCanvas.tsx (675줄)

| 항목 | 상태 |
|------|------|
| 역할 | 이미지 + 블록 렌더링 (Konva) |
| 점수 | 7/10 |

**문제점**:
1. 이미지 로딩 레이스 컨디션
2. 드래그 선택 시 onBlockSelect 다중 호출 (100개 → 100번)
3. Konva 객체 명시적 정리 부재

---

#### workSessionStore.ts

| 항목 | 상태 |
|------|------|
| 역할 | 작업 세션 전역 상태 관리 |
| 점수 | 6/10 |

**문제점**:
1. 디바운스 전역 상태로 인한 예기치 않은 동작
2. currentSession deep clone 없음 → 객체 참조 문제
3. error 상태 초기화 시점 불명확

---

## 2. 데이터 흐름 우려사항

### 2.1 크리티컬 흐름: 그룹 생성 → 확정 → 내보내기

```
사용자 선택 (블록)
    ↓
handleCreateGroup()
    ↓
localGroups 상태 업데이트 (메모리)
    ↓
saveImmediately() → groups.json 저장
    ↓ ⚠️ 100ms 지연 (고정, 환경 무관)
exportWithRetry() → 이미지 크롭 & 내보내기
    ↓
문제은행 등록 완료
```

**위험점**:
- saveImmediately 완료를 기다리지 않음
- export 실패 시 그룹은 유지 (이미지 없이 metadata만 남음)

### 2.2 데이터 불일치 시나리오

| 시나리오 | 원인 | 결과 |
|---------|------|------|
| 동시 편집 | 탭 1, 탭 2에서 동시 수정 | groups.json 버전 차이 |
| XP 그룹 삭제 | groups.json만 삭제 | session.problems에 잔존 |
| 이미지 로  드 실패 | 썸네일만 표시 | 잘못된 블록 선택 저장 |

---

## 3. 전체 시스템 안정성 평가

### 3.1 카테고리별 점수

| 카테고리 | 점수 | 코멘트 |
|---------|------|-------|
| 아키텍처 설계 | 7/10 | 모듈화 잘됨, 상태 관리 복잡 |
| 에러 처리 | 6/10 | try-catch 많지만 복구 전략 부족 |
| 동시성 제어 | 5/10 | Race condition 여러 개 |
| 데이터 일관성 | 6/10 | 다중 파일 쓰기 원자성 보장 안됨 |
| UI 안정성 | 7/10 | 기본 동작 안정적 |
| 성능 | 7/10 | 최적화 일부 적용 |
| 테스트 커버리지 | 2/10 | 테스트 코드 없음 |
| 모니터링 | 4/10 | 로깅만 있음 |

**평균: 6.1/10**

### 3.2 리스크 레벨

| 위험도 | 사례 | 빈도 |
|--------|------|------|
| Critical | Export 실패 후 metadata만 남음 | 낮음 |
| High | 동시 편집 시 데이터 불일치 | 중간 |
| Medium | On-Demand 이미지 변환 성능 | 높음 |
| Low | 자동 확정 조건 불명확 | 중간 |

---

## 4. 권장 조치사항

### 4.1 즉시 조치 (1주일 내)

1. **saveImmediately + export 동기화**
   - await saveImmediately() 후 export 시작

2. **Race Condition 방지**
   - 페이지 전환 시 saveGroups를 task 큐로 관리

3. **파일 리소스 정리**
   - Context Manager로 Image 객체 관리

4. **에러 로깅 표준화**
   - 구조화된 로그 (document_id, page_index, attempt)

### 4.2 단기 개선 (1개월 내)

5. **상태 관리 정리**
   - PageViewer useState 17개 → 3-4개로 축소

6. **이미지 로딩 최적화**
   - 썸네일 캐시 + CDN

7. **동기화 일관성**
   - atomic-link-create API (트랜잭션)

8. **테스트 작성**
   - Backend: pytest
   - Frontend: Vitest
   - E2E: Playwright

### 4.3 장기 개선 (3개월 내)

9. **아키텍처 리팩토링**
   - 이벤트 기반 아키텍처

10. **모니터링 시스템**
    - Prometheus + Sentry + CloudWatch

---

## 5. 데이터 초기화 권장 사항

### 현재 데이터 상태

| 항목 | 상태 | 문제점 |
|------|------|--------|
| documents/ | 3개 폴더 | 구 버전 데이터 혼재 |
| work_sessions/ | 1개 파일 | 불일치 데이터 가능 |
| problems/ | 다수 PNG | 고아 파일 가능 |

### 초기화 대상

```
dataset_root/
├── documents/           # 삭제 후 재업로드
│   ├── groups/          # 그룹 데이터
│   ├── problems/        # 내보낸 이미지
│   └── blocks/          # 블록 데이터
└── work_sessions/       # 삭제
```

### 초기화 명령어

```bash
# 1. 백업 (선택사항)
xcopy dataset_root dataset_root_backup /E /I

# 2. 초기화
del /S /Q dataset_root\documents\*\groups\*
del /S /Q dataset_root\documents\*\problems\*
del /S /Q dataset_root\work_sessions\*

# 3. 또는 전체 삭제 후 재업로드
rmdir /S /Q dataset_root\documents
rmdir /S /Q dataset_root\work_sessions
```

---

## 6. 결론

**현재 시스템은 기능적으로 완성도가 높지만, 데이터 일관성 보장이 약합니다.**

**권장 조치**:
1. 데이터 초기화 후 클린 스타트
2. Phase 59로 안정성 개선 작업 진행
3. 즉시 조치 사항 4개 우선 적용

---

*작성: Claude Code*
