# 모문제-하위문제 컨텍스트 연결 시스템 연구 리포트

**문서 번호**: 207
**작성일**: 2025-12-06
**목적**: 하위 문제가 모문제 컨텍스트에 의존하는 경우의 라벨링 솔루션 연구
**상태**: 연구 단계

---

## 1. 문제 정의

### 1.1 현재 상황

```
┌─────────────────────────────────────────────────────────┐
│ 두 다항식 A=2x³-3x²+x-6, B=4x²-2x+1에 대하여           │
│ 다음을 계산하시오.                          [모문제]    │
├─────────────────────────────────────────────────────────┤
│ 19. A+B                                    [하위문제]   │
├─────────────────────────────────────────────────────────┤
│ 20. A-B                                    [하위문제]   │
├─────────────────────────────────────────────────────────┤
│ 21. 3A+2B                                  [하위문제]   │
└─────────────────────────────────────────────────────────┘
```

### 1.2 문제점

| 크롭 방식 | 결과 |
|----------|------|
| 19번만 크롭 | "A+B" → A, B가 뭔지 모름 (풀이 불가) |
| 20번만 크롭 | "A-B" → A, B가 뭔지 모름 (풀이 불가) |
| 21번만 크롭 | "3A+2B" → A, B가 뭔지 모름 (풀이 불가) |

**핵심 문제**: 하위 문제 이미지만으로는 **자기완결적(Self-contained)**이지 않음

### 1.3 이 패턴이 나타나는 경우

```
1. 공통 조건 제시형
   "다음 조건에서 물음에 답하시오"
   → (1) ... (2) ... (3) ...

2. 그래프/도형 참조형
   [그래프 이미지]
   → 1번: 최댓값은?  2번: x절편은?

3. 지문 기반형 (국어/영어)
   [긴 지문]
   → 1~3번 문제

4. 데이터 기반형
   [표/통계 자료]
   → (가) ... (나) ... (다) ...
```

---

## 2. 솔루션 제안

### Solution A: 복합 크롭 (Composite Crop)

```
┌─────────────────────────────────────────┐
│ 모문제 텍스트                           │  ← 항상 포함
│ A=2x³-3x²+x-6, B=4x²-2x+1              │
├─────────────────────────────────────────┤
│ 19. A+B                                 │  ← 해당 하위문제
└─────────────────────────────────────────┘

크롭 결과: 모문제 + 하위문제가 하나의 이미지로 합쳐짐
```

**구현 방식**:
1. 그룹에 `parent_group_id` 필드 추가
2. 내보내기 시 parent 그룹 이미지를 상단에 합성
3. 또는 parent 영역을 각 하위문제 크롭에 포함

**장점**:
- 각 크롭 이미지가 자기완결적
- 기존 워크플로우 변경 최소화
- AI/학생 모두 이미지만으로 풀이 가능

**단점**:
- 이미지 용량 증가 (모문제 반복)
- 크롭 이미지가 세로로 길어짐

---

### Solution B: 메타데이터 참조 (Reference System)

```json
// 19번 문제 메타데이터
{
  "problem_id": "p19",
  "image": "problem_19.png",
  "parent_id": "p19_parent",
  "parent_image": "problem_19_parent.png",
  "requires_context": true
}
```

**구현 방식**:
1. 모문제를 별도 그룹으로 저장
2. 하위문제에 `parent_id` 참조 추가
3. 뷰어/출력 시 부모 이미지 함께 표시

**장점**:
- 저장 공간 효율적 (모문제 1회만 저장)
- 유연한 구조 (N개 하위문제 → 1개 모문제)
- 메타데이터로 관계 추적 가능

**단점**:
- 내보내기 로직 복잡
- 단일 이미지로 사용 시 추가 처리 필요

---

### Solution C: 그룹 계층 구조 (Hierarchical Groups)

```
Group: "19-21번 세트"
├── Parent Block: "두 다항식 A=... 대하여 다음을 계산하시오"
├── Child 1: "19. A+B"
├── Child 2: "20. A-B"
└── Child 3: "21. 3A+2B"
```

**구현 방식**:
1. 그룹 내에 `parent_blocks[]`와 `child_blocks[]` 구분
2. 하나의 그룹이 여러 하위문제 포함
3. 내보내기 옵션: 통합 또는 개별+컨텍스트

**장점**:
- 논리적으로 가장 정확한 표현
- 세트 문제 전체 관리 용이

**단점**:
- 기존 1그룹=1문제 패러다임 변경
- UI/UX 복잡도 증가

---

### Solution D: 하이브리드 (권장)

**기본 원칙**:
- 저장은 Solution B (참조 방식)
- 내보내기는 Solution A (복합 크롭)

```
┌─────────────────────────────────────────────────────────┐
│  라벨링 시                                              │
│  ┌───────────┐    ┌───────────┐    ┌───────────┐       │
│  │ 모문제    │    │ 19번      │    │ 20번      │       │
│  │ (별도그룹)│◄───│ parent_id │    │ parent_id │       │
│  └───────────┘    └───────────┘    └───────────┘       │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼ 내보내기
┌─────────────────────────────────────────────────────────┐
│  결과 이미지                                            │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │ 모문제          │  │ 모문제          │              │
│  │ ───────────     │  │ ───────────     │              │
│  │ 19. A+B         │  │ 20. A-B         │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 권장 솔루션 상세 설계 (Solution D)

### 3.1 데이터 구조 변경

```typescript
// 기존 Group 구조
interface Group {
  group_id: string;
  blocks: number[];
  label: string;
  // ...
}

// 변경된 Group 구조
interface Group {
  group_id: string;
  blocks: number[];
  label: string;

  // NEW: 모문제 연결
  parent_group_id?: string;      // 모문제 그룹 ID (있으면 하위문제)
  is_context_provider?: boolean; // true면 이 그룹은 모문제
}
```

### 3.2 UI 워크플로우

```
Step 1: 모문제 그룹 생성
        ┌─────────────────────────────┐
        │ [블록 선택: 모문제 텍스트]  │
        │ [라벨: 컨텍스트 제공자 체크]│
        └─────────────────────────────┘

Step 2: 하위문제 그룹 생성
        ┌─────────────────────────────┐
        │ [블록 선택: 19번]           │
        │ [모문제 연결: 드롭다운]     │
        │   └─ "두 다항식 A=..."      │
        └─────────────────────────────┘

Step 3: 반복 (20번, 21번...)
```

### 3.3 내보내기 옵션

```
내보내기 설정:
┌─────────────────────────────────────────┐
│ ☑ 모문제 컨텍스트 포함                  │
│   ○ 상단에 합성 (권장)                  │
│   ○ 별도 파일로 저장                    │
│   ○ 메타데이터만 (이미지 합성 안함)     │
│                                         │
│ ☐ 모문제 없는 문제도 내보내기           │
└─────────────────────────────────────────┘
```

---

## 4. 구현 가능성 분석

### 4.1 Backend 변경

| 파일 | 변경 내용 | 난이도 |
|------|----------|--------|
| `blocks.py` | Group에 parent_group_id 필드 추가 | 쉬움 |
| `export.py` | 이미지 합성 로직 추가 | 중간 |
| `work_sessions.py` | 세션에 관계 저장 | 쉬움 |

**예상 코드 (이미지 합성)**:
```python
from PIL import Image

def create_composite_crop(
    page_image: Image,
    parent_group: Group,
    child_group: Group,
    margin: int = 20
) -> Image:
    """모문제 + 하위문제 합성 이미지 생성"""

    # 모문제 영역 크롭
    parent_crop = crop_group_area(page_image, parent_group)

    # 하위문제 영역 크롭
    child_crop = crop_group_area(page_image, child_group)

    # 합성 (세로 배치)
    total_height = parent_crop.height + margin + child_crop.height
    max_width = max(parent_crop.width, child_crop.width)

    composite = Image.new('RGB', (max_width, total_height), 'white')
    composite.paste(parent_crop, (0, 0))
    composite.paste(child_crop, (0, parent_crop.height + margin))

    return composite
```

### 4.2 Frontend 변경

| 컴포넌트 | 변경 내용 | 난이도 |
|----------|----------|--------|
| `PageViewer.tsx` | 모문제 연결 UI 추가 | 중간 |
| `GroupPanel.tsx` | parent 선택 드롭다운 | 쉬움 |
| `ExportModal.tsx` | 합성 옵션 체크박스 | 쉬움 |

### 4.3 구현 시간 예상

| 단계 | 작업 | 시간 |
|------|------|------|
| 1 | 데이터 구조 변경 (Group 스키마) | 1시간 |
| 2 | Backend API 수정 | 2시간 |
| 3 | Frontend UI 추가 | 3시간 |
| 4 | 이미지 합성 로직 | 2시간 |
| 5 | 테스트 및 디버깅 | 2시간 |
| **총** | | **10시간** |

---

## 5. 우려 사항

### 5.1 UX 복잡도 증가

| 우려 | 심각도 | 대응 |
|------|--------|------|
| 사용자가 모문제 연결을 잊을 수 있음 | 🟡 중간 | 자동 감지 제안 기능 |
| 워크플로우 단계 증가 | 🟡 중간 | 단축키로 빠른 연결 |
| 모문제 그룹 먼저 만들어야 함 | 🟢 낮음 | 순서 강제 또는 나중 연결 허용 |

### 5.2 데이터 무결성

| 우려 | 심각도 | 대응 |
|------|--------|------|
| 모문제 삭제 시 하위문제 고아됨 | 🔴 높음 | CASCADE 삭제 또는 경고 |
| 페이지 이동 시 관계 유지 | 🟡 중간 | 같은 페이지 내에서만 연결 허용 |
| 순환 참조 가능성 | 🟢 낮음 | 검증 로직 추가 |

### 5.3 내보내기 복잡도

| 우려 | 심각도 | 대응 |
|------|--------|------|
| 합성 이미지 품질 | 🟡 중간 | 경계선/여백 디자인 |
| 페이지 넘김 모문제 | 🔴 높음 | 이전 페이지 로드 필요 |
| 대량 내보내기 성능 | 🟡 중간 | 비동기 처리, 프로그레스바 |

### 5.4 특수 케이스

```
케이스 1: 모문제가 이전 페이지에 있음
          → 복잡도 상승, Phase 2에서 처리

케이스 2: 하나의 모문제 → 10개 이상 하위문제
          → 지원 가능, UI 스크롤 필요

케이스 3: 중첩 모문제 (모문제의 모문제)
          → 지원 안함 (1단계 계층만)

케이스 4: 그래프/이미지가 모문제
          → 지원 가능 (블록 선택 동일)
```

---

## 6. 대안 검토

### 대안 1: 수동 합성 (현재 가능)

사용자가 모문제 + 하위문제를 하나의 그룹으로 묶음

```
❌ 문제점:
- 19, 20, 21번이 같은 그룹 → 3문제가 1개로 취급
- 문제 개수 통계 왜곡
- 개별 문제 관리 불가
```

### 대안 2: 후처리 도구

별도 도구에서 이미지 합성

```
❌ 문제점:
- 워크플로우 분리
- 수작업 증가
- 실수 가능성
```

### 대안 3: AI 자동 감지

AI가 "A=..., B=..."를 감지하고 자동 연결

```
⚠️ 장기적으로 가능하나:
- 현재 범위 초과
- 정확도 보장 어려움
- Phase 60+ 에서 검토
```

---

## 7. 결론 및 권장사항

### 7.1 구현 가능성: ✅ 가능

기존 시스템에 **parent_group_id 참조 방식**을 추가하는 것은 기술적으로 충분히 가능합니다.

### 7.2 권장 구현 순서

```
Phase 1 (MVP): 같은 페이지 내 연결
├─ parent_group_id 필드 추가
├─ 기본 UI (드롭다운 연결)
└─ 내보내기 시 합성

Phase 2 (확장): 페이지 간 연결
├─ 이전 페이지 모문제 참조
└─ 세션 레벨 모문제 관리

Phase 3 (자동화): AI 제안
├─ 패턴 감지 ("다음을 계산하시오")
└─ 자동 연결 제안
```

### 7.3 최종 권장

| 상황 | 권장 |
|------|------|
| 빠른 구현 원할 때 | Phase 1만 진행 (~10시간) |
| 완전한 솔루션 원할 때 | Phase 1 → 2 순차 진행 |
| 현재 우선순위 낮을 때 | 수동 합성으로 우회 |

### 7.4 핵심 요약

> **문제**: 하위문제 크롭이 자기완결적이지 않음
>
> **솔루션**: `parent_group_id` 참조 + 내보내기 시 이미지 합성
>
> **난이도**: 중간 (10시간)
>
> **위험도**: 낮음 (기존 기능에 영향 없음)

---

*이 문서는 연구 단계이며, 개발은 진행되지 않았습니다.*
*승인 후 실행: "모문제 연결 기능 구현해줘" 또는 "Phase 1만 진행해줘"*
